<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ôn tập Flashcard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        /* (CSS Giao diện đẹp giữ nguyên) */
        body { background-color: #f0f2f5; }
        .card-container { width: 100%; max-width: 600px; height: 350px; perspective: 1000px; margin: 20px auto; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.5rem; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-front { background-color: #fff; border: 1px solid #ddd; }
        .card-back { background-color: #0d6efd; color: white; transform: rotateY(180deg); }
        .review-navigation { display: none; max-width: 600px; margin: 0 auto; padding-top: 15px; }
        .review-navigation .btn { font-size: 1.1rem; padding: 0.75rem 1rem; }
        #sessionComplete { display: none; max-width: 600px; margin: 20px auto; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-warning shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand text-dark" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <h4 class="navbar-text text-dark mb-0" id="setTitle">Đang tải...</h4>
        <a class="btn btn-outline-dark" id="backButton" href="/dashboard">
            <i class="bi bi-arrow-left-circle"></i> Quay lại
        </a>
    </div>
</nav>

<div class="container">

    <div id="pageLoading" class="text-center mt-5">
        <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div>
        <h4 class="mt-3">Đang tải thẻ ôn tập...</h4>
    </div>

    <div id="sessionComplete" class="text-center card shadow-sm p-4" style="display: none;">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
        <h2 class="mt-3">Tuyệt vời!</h2>
        <p class="lead">Bạn đã hoàn thành phiên ôn tập này.</p>
        <a href="/dashboard" class="btn btn-primary mt-2">Quay về Dashboard</a>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="card-container" id="cardContainer">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front" id="cardFront">Mặt trước...</div>
                <div class="card-face card-back" id="cardBack">Mặt sau...</div>
            </div>
        </div>

        <div class="text-center">
            <span id="cardCounter" class="text-muted fw-bold">1 / 10</span>
        </div>

        <div class="review-navigation" id="reviewNavigation">
            <div class="d-grid gap-3 grid-cols-2 d-flex">
                <button class="btn btn-danger w-100" onclick="handleReview(false)">
                    <i class="bi bi-x-lg"></i> Không nhớ
                </button>
                <button class="btn btn-success w-100" onclick="handleReview(true)">
                    <i class="bi bi-check-lg"></i> Nhớ
                </button>
            </div>
        </div>

        <div class="text-center mt-3" id="flipInstruction">
            <p class="text-muted">(Nhấn vào thẻ hoặc bấm phím Space để lật)</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allCards = [];
    let currentCardIndex = 0;
    let boxNumber = null;
    let userSubjectId = null; // <-- THÊM BIẾN NÀY

    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }
        $.ajaxSetup({
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });

        // ==========================================================
        // === SỬA LỖI 1: LẤY MỐC VÀ ID MÔN HỌC TỪ URL ===
        // ==========================================================

        // Lấy Mốc (boxNumber) từ đường dẫn (ví dụ: /milestone/2)
        const pathParts = window.location.pathname.split('/');
        boxNumber = pathParts[pathParts.length - 1];

        // Lấy ID Môn học từ query param (ví dụ: ?subject=5)
        const urlParams = new URLSearchParams(window.location.search);
        userSubjectId = urlParams.get('subject');

        if(!boxNumber || !userSubjectId || isNaN(boxNumber) || isNaN(userSubjectId)) {
            $("#pageLoading").html('<h4 class="text-danger">Lỗi: Không tìm thấy Mốc hoặc ID Môn học hợp lệ.</h4>');
            return;
        }
        // === KẾT THÚC SỬA LỖI 1 ===

        loadFlashcardData(boxNumber, userSubjectId); // <-- Truyền cả hai

        $("#cardContainer").on("click", flipCard);

        $(document).on('keydown', function(e) {
            if ($("#mainContent").is(":visible") && !$("#sessionComplete").is(":visible")) {
                 if (e.which === 32) { e.preventDefault(); flipCard(); }
                 else if (e.which === 37) { e.preventDefault(); if ($("#reviewNavigation").is(":visible")) { handleReview(false); } }
                 else if (e.which === 39) { e.preventDefault(); if ($("#reviewNavigation").is(":visible")) { handleReview(true); } }
            }
        });
    });

    /**
     * =================================================================
     * SỬA LỖI 2: GỌI ĐÚNG API VÀ ĐỌC DỮ LIỆU
     * =================================================================
     */
    function loadFlashcardData(boxNumber, userSubjectId) {
        $.ajax({
            type: "GET",
            // Gọi API mới (đã tạo ở bước 3)
            url: `http://localhost:8080/api/my-subject/${userSubjectId}/review/milestone/${boxNumber}`,
            success: function(data) { // 'data' là FlashcardSetDTO

                allCards = data.flashcards || []; // Lấy danh sách từ BÊN TRONG DTO

                if (allCards.length === 0) {
                    $("#pageLoading").hide();
                    $("#mainContent").hide();
                    $("#sessionComplete").find("h2").text("Tuyệt vời!");
                    $("#sessionComplete").find("p.lead").text("Bạn không có thẻ nào trong mốc này để ôn tập.");
                    $("#sessionComplete").show();
                    return;
                }

                $("#setTitle").text(data.title); // Lấy tiêu đề từ DTO
                // Cập nhật link quay lại trang môn học
                $("#backButton").attr("href", "/my-subject/" + userSubjectId);

                currentCardIndex = 0;
                showCard(currentCardIndex);

                $("#pageLoading").hide();
                $("#mainContent").show();
            },
            error: function(xhr) {
                // Đây là nơi hiển thị lỗi "Oops!"
                $("#pageLoading").hide();
                $("#mainContent").hide();
                $("#sessionComplete").find("i").attr("class", "bi bi-exclamation-triangle-fill text-danger");
                $("#sessionComplete").find("h2").text("Oops!");
                $("#sessionComplete").find("p.lead").text("Có lỗi xảy ra khi tải thẻ flashcard. Vui lòng thử lại sau.");
                $("#sessionComplete").show();
            }
        });
    }
    // === KẾT THÚC SỬA LỖI 2 ===


    function showCard(index) {
        if (index >= allCards.length) {
            $("#mainContent").hide();
            // Cập nhật link quay lại trang môn học
            $("#sessionComplete").find("a").attr("href", "/my-subject/" + userSubjectId);
            $("#sessionComplete").show();
            return;
        }
        const card = allCards[index];
        $("#reviewNavigation").hide();
        $("#flipInstruction").show();
        $("#flashcard").removeClass("is-flipped");
        setTimeout(() => {
            $("#cardFront").text(card.frontText);
            $("#cardBack").text(card.backText);
        }, 300);
        $("#cardCounter").text(`${index + 1} / ${allCards.length}`);
    }

    // (Hàm này đã sửa lỗi lật 1 chiều)
    function flipCard() {
        const $card = $("#flashcard");
        $card.toggleClass("is-flipped");
        if ($card.hasClass("is-flipped")) {
            $("#reviewNavigation").show();
            $("#flipInstruction").hide();
        } else {
            $("#reviewNavigation").hide();
            $("#flipInstruction").show();
        }
    }

    // (Hàm này đã khớp với API /review)
    function handleReview(wasRemembered) {
        const currentCard = allCards[currentCardIndex];
        const cardId = currentCard.flashcardId;
        if (!cardId) {
             alert("Lỗi: Không tìm thấy flashcardId.");
             return;
        }

        $("#reviewNavigation").find("button").prop("disabled", true);

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/flashcards/review",
            contentType: "application/json",
            data: JSON.stringify({
                flashcardId: cardId,
                wasRemembered: wasRemembered
            }),
            success: function() {
                currentCardIndex++;
                showCard(currentCardIndex);
            },
            error: function(xhr) {
                alert("Lỗi khi lưu tiến độ: " + (xhr.responseJSON?.message || xhr.responseText));
                if (xhr.status === 401 || xhr.status === 403) logout();
            },
            complete: function() {
                $("#reviewNavigation").find("button").prop("disabled", false);
            }
        });
    }

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }
</script>
</body>
</html>