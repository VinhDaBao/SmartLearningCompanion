<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-sm border-0" style="margin-top: 100px;">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">Smart Learning Companion</h3>

                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Đăng nhập</button>
                        </div>
                    </form>

                    <div id="errorMessage" class="alert alert-danger mt-3 d-none" role="alert">
                    </div>

                </div>
                <div class="card-footer text-center py-3">
                    <small>Chưa có tài khoản? <a href="/register">Đăng ký ngay</a></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    $(document).ready(function() {

        // Bắt sự kiện "submit" của form
        $("#loginForm").on("submit", function(event) {
            // Ngăn form gửi đi theo cách truyền thống
            event.preventDefault();

            // Ẩn thông báo lỗi cũ (nếu có)
            $("#errorMessage").addClass("d-none");

            // 1. Lấy dữ liệu từ form
            var username = $("#username").val();
            var password = $("#password").val();

            // Tạo đối tượng JSON
            var loginData = {
                username: username,
                password: password
            };

            // 2. Gửi yêu cầu AJAX (jQuery) đến Backend
            $.ajax({
                type: "POST",
                url: "http://localhost:8080/api/auth/login", // API login của bạn
                contentType: "application/json",
                data: JSON.stringify(loginData), // Chuyển JS object -> JSON string

                // 3. Xử lý khi THÀNH CÔNG
                success: function(response) {
                    // "response" ở đây là AuthResponseDTO
                    console.log("Đăng nhập thành công!");
                    console.log("Token: " + response.token);

                    // ⚠️ QUAN TRỌNG: Lưu token vào Local Storage
                    localStorage.setItem("jwtToken", response.token);
                    localStorage.setItem("username", response.username);

                    // Chuyển hướng sang trang Dashboard
                    window.location.href = "/dashboard";
                },

                // 4. Xử lý khi THẤT BẠI (ví dụ: sai pass)
                error: function(xhr) {
                    // xhr.responseText chính là thông báo lỗi từ @ExceptionHandler
                    var errorMsg = xhr.responseText || "Lỗi không xác định";

                    $("#errorMessage").text(errorMsg);
                    $("#errorMessage").removeClass("d-none");
                }
            });
        });
    });
</script>
</body>
</html>