<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Flashcard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f0f2f5;
        }
        /* --- CSS CHO HIỆU ỨNG LẬT THẺ 3D --- */
        .card-container {
            width: 100%;
            max-width: 600px;
            height: 350px;
            perspective: 1000px; /* Tạo chiều sâu 3D */
            margin: 20px auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d; /* Giữ 3D */
            transition: transform 0.6s;
            cursor: pointer;
        }
        /* Khi bấm (thêm class 'is-flipped'), thẻ sẽ lật */
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Ẩn mặt sau */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* Mặt trước */
        .card-front {
            background-color: #fff;
            border: 1px solid #ddd;
        }
        /* Mặt sau (lật ngược lại) */
        .card-back {
            background-color: #0d6efd;
            color: white;
            transform: rotateY(180deg);
        }
        /* --- HẾT CSS 3D --- */

        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-warning shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand text-dark" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <h4 class="navbar-text text-dark mb-0" id="setTitle">Đang tải...</h4>
        <a class="btn btn-outline-dark" id="backButton" href="#">
            <i class="bi bi-arrow-left-circle"></i> Quay lại
        </a>
    </div>
</nav>

<div class="container">

    <div id="pageLoading" class="text-center mt-5">
        <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div>
        <h4 class="mt-3">Đang tải bộ thẻ...</h4>
    </div>

    <div id="mainContent" style="display: none;">

        <div class="card-container" id="cardContainer">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front" id="cardFront">
                    Mặt trước...
                </div>
                <div class="card-face card-back" id="cardBack">
                    Mặt sau...
                </div>
            </div>
        </div>

        <div class="card-navigation">
            <button class="btn btn-outline-secondary" id="prevCard" disabled>
                <i class="bi bi-arrow-left"></i> Thẻ trước
            </button>
            <span id="cardCounter" class="text-muted fw-bold">1 / 10</span>
            <button class="btn btn-warning" id="nextCard">
                Thẻ sau <i class="bi bi-arrow-right"></i>
            </button>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let setId = null;
    let allCards = []; // Lưu trữ tất cả các thẻ
    let currentCardIndex = 0; // Vị trí thẻ hiện tại

    $(document).ready(function() {
        // 1. Kiểm tra đăng nhập
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }
        $.ajaxSetup({
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });

        // 2. Lấy setId từ URL
        const pathParts = window.location.pathname.split('/');
        setId = pathParts[pathParts.length - 1];

        // 3. Tải dữ liệu
        loadFlashcardData(setId);

        // 4. Gắn sự kiện Click
        $("#cardContainer").on("click", flipCard);
        $("#prevCard").on("click", prevCard);
        $("#nextCard").on("click", nextCard);

        // (Cho phép dùng phím mũi tên)
        $(document).on('keydown', function(e) {
            if (e.which === 37) { // Mũi tên trái
                $("#prevCard").click();
            } else if (e.which === 39) { // Mũi tên phải
                $("#nextCard").click();
            } else if (e.which === 32) { // Phím Space
                e.preventDefault();
                flipCard();
            }
        });
    });

    function loadFlashcardData(setId) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/flashcards/${setId}`,
            success: function(data) {
                // data là FlashcardSetDTO
                allCards = data.flashcards || [];
                if (allCards.length === 0) {
                    alert("Bộ thẻ này không có thẻ nào!");
                    return;
                }

                $("#setTitle").text(data.title);
                // Lấy userSubjectId từ API (nếu bạn đã thêm nó vào DTO)
                // Hoặc chúng ta quay lại dashboard
                $("#backButton").attr("href", "/dashboard");

                // Hiển thị thẻ đầu tiên
                currentCardIndex = 0;
                showCard(currentCardIndex);

                $("#pageLoading").hide();
                $("#mainContent").show();
            },
            error: function(xhr) {
                alert("Lỗi tải Flashcard: " + xhr.responseText);
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    /**
     * Hiển thị nội dung thẻ tại vị trí 'index'
     */
    function showCard(index) {
        const card = allCards[index];

        // 1. "Lật" thẻ về mặt trước (nếu đang ở mặt sau)
        $("#flashcard").removeClass("is-flipped");

        // 2. Cập nhật nội dung (sau 0.3s để chờ thẻ lật xong)
        setTimeout(() => {
            $("#cardFront").text(card.frontText);
            $("#cardBack").text(card.backText);
        }, 300); // 300ms = 1/2 thời gian lật (0.6s)

        // 3. Cập nhật bộ đếm
        $("#cardCounter").text(`${index + 1} / ${allCards.length}`);

        // 4. Cập nhật nút điều hướng
        $("#prevCard").prop('disabled', index === 0);
        $("#nextCard").prop('disabled', index === allCards.length - 1);
    }

    /**
     * Lật thẻ
     */
    function flipCard() {
        $("#flashcard").toggleClass("is-flipped");
    }

    /**
     * Chuyển thẻ tiếp theo
     */
    function nextCard() {
        if (currentCardIndex < allCards.length - 1) {
            currentCardIndex++;
            showCard(currentCardIndex);
        }
    }

    /**
     * Chuyển thẻ trước đó
     */
    function prevCard() {
        if (currentCardIndex > 0) {
            currentCardIndex--;
            showCard(currentCardIndex);
        }
    }

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

</script>
</body>
</html>