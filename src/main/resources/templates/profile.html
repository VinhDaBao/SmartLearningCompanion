<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ của tôi - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        .loading-spinner { display: none; width: 1.2rem; height: 1.2rem; vertical-align: text-bottom; border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: .75s linear infinite spinner-border; }
        .profile-container { max-width: 700px; margin-top: 30px; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <div class="d-flex">
            <a class="btn btn-outline-light me-3" href="/dashboard">
                <i class="bi bi-arrow-left-circle"></i> Về Dashboard
            </a>
            <button class="btn btn-outline-light" id="logoutButton"><i class="bi bi-box-arrow-right"></i> Đăng xuất</button>
        </div>
    </div>
</nav>

<div class="container profile-container">

    <div id="pageLoading" class="text-center mt-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3">Đang tải hồ sơ...</h4>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h2 class="h4 mb-0"><i class="bi bi-person-circle text-primary"></i> Hồ sơ của tôi</h2>
            </div>
            <div class="card-body p-4">

                <form id="profileForm">
                    <div id="successMessage" class="alert alert-success d-none" role="alert"></div>
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

                    <div class="mb-3">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                            <input type="text" class="form-control" id="username" disabled>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                            <input type="email" class="form-control" id="email" disabled>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="fullName" class="form-label">Họ và tên</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person-vcard"></i></span>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="learningStyle" class="form-label fw-bold">
                            <i class="bi bi-magic text-success"></i> Phong cách học AI
                        </label>
                        <select class="form-select" id="learningStyle" required>
                            <option value="" disabled>-- Chọn phong cách học --</option>
                            <option value="Visual">Visual (Hình ảnh)</option>
                            <option value="Auditory">Auditory (Âm thanh)</option>
                            <option value="Reading/Writing">Reading/Writing (Đọc/Viết)</option>
                            <option value="Kinesthetic">Kinesthetic (Thực hành)</option>
                            <option value="General">General (Tổng quát)</option>
                        </select>
                        <div class="form-text">Việc này sẽ thay đổi cách AI tạo nội dung cho bạn.</div>
                    </div>

                    <hr class="my-4">

                    <button type="submit" class="btn btn-primary btn-lg" id="saveButton">
                        <span class="loading-spinner" role="status"></span>
                        <i class="bi bi-save"></i> Lưu thay đổi
                    </button>
                </form>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        // 1. Kiểm tra đăng nhập
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });
        $("#logoutButton").on("click", logout);

        // 2. Tải dữ liệu Profile
        loadProfile();

        // 3. Gắn sự kiện Submit
        $("#profileForm").on("submit", handleProfileUpdate);
    });

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    /**
     * Hàm tải thông tin user hiện tại
     */
    function loadProfile() {
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/api/profile", // API chúng ta vừa tạo
            success: function(user) {
                // user là UserDTO

                // 1. Điền thông tin vào form
                $("#username").val(user.username);
                $("#email").val(user.email);
                $("#fullName").val(user.fullName);

                // QUAN TRỌNG: Chọn đúng <option> cho phong cách học
                $("#learningStyle").val(user.learningStyle);

                // 2. Hiển thị form
                $("#pageLoading").hide();
                $("#mainContent").show();
            },
            error: function(xhr) {
                $("#pageLoading").html(`<h4 class="text-danger">Lỗi tải hồ sơ: ${xhr.responseText}</h4>`);
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    /**
     * Hàm xử lý Cập nhật
     */
    function handleProfileUpdate(event) {
        event.preventDefault();

        const btn = $("#saveButton");
        const spinner = btn.find(".loading-spinner");

        // Ẩn thông báo cũ
        $("#successMessage").addClass("d-none");
        $("#errorMessage").addClass("d-none");

        btn.prop('disabled', true);
        spinner.show();

        // 1. Lấy dữ liệu mới
        const updatedData = {
            fullName: $("#fullName").val(),
            learningStyle: $("#learningStyle").val()
        };

        // 2. Gọi API PUT
        $.ajax({
            type: "PUT",
            url: "http://localhost:8080/api/profile",
            contentType: "application/json",
            data: JSON.stringify(updatedData),
            success: function(userDTO) {
                $("#successMessage").text("Cập nhật hồ sơ thành công!").removeClass("d-none");
            },
            error: function(xhr) {
                $("#errorMessage").text("Lỗi: " + xhr.responseText).removeClass("d-none");
            },
            complete: function() {
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

</script>
</body>
</html>