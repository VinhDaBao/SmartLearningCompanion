<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        .loading-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: text-bottom;
            border: .2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: .75s linear infinite spinner-border;
        }

        .toast-container {
            z-index: 1100;
        }

        .subject-card {
            background: #ffffff;
            border-radius: 1rem;
            border: 1px solid #e3e6f0;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.25rem;
            transition: all .15s ease-in-out;
            /* Th√™m z-index ƒë·ªÉ n√≥ n·ªïi l√™n tr√™n th·∫ª AI */
            position: relative;
            z-index: 2;
        }

        .subject-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #0d6efd33;
        }

        .subject-info h5 {
            margin-bottom: .25rem;
        }

        .subject-info .progress-text {
            font-size: 0.9rem;
        }

        .subject-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .subject-actions .btn {
            min-width: 130px;
            font-weight: 500;
            border-radius: 999px;
        }

        @media (max-width: 768px) {
            .subject-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .subject-actions {
                width: 100%;
            }

            .subject-actions .btn {
                flex: 1 1 calc(50% - 0.5rem);
            }
        }

        /* --- CSS CHO TH·∫∫ ƒê·ªÄ XU·∫§T TH√îNG MINH (ƒê√É TH√äM) --- */

        .adaptive-recommendation-box {
            font-family: Arial, sans-serif;
            background: #f0f4f9; /* M√†u n·ªÅn xanh nh·∫°t */
            border-radius: 0 0 12px 12px; /* Ch·ªâ bo g√≥c d∆∞·ªõi */
            padding: 24px;
            margin-top: -10px; /* H∆°i ch·ªìng l√™n th·∫ª m√¥n h·ªçc */
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0, 50, 150, 0.1);
            border: 1px solid #dbe6f0;
            /* Th·∫ª AI n·∫±m b√™n d∆∞·ªõi th·∫ª m√¥n h·ªçc */
            position: relative;
            z-index: 1;
        }

        /* 1. Tr·∫°ng th√°i ƒêang t·∫£i (Loading) */
        .adaptive-loading {
            text-align: center;
            color: #0056b3; /* M√†u xanh ƒë·∫≠m */
        }
        .adaptive-loading p {
            font-style: italic;
            color: #555;
            margin-bottom: 0;
        }

        /* CSS cho con quay "spinner" */
        .adaptive-loading .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #dbe6f0;
            border-top-color: #0056b3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 2. Tr·∫°ng th√°i N·ªôi dung (Content) */
        .adaptive-content {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }

        .adaptive-content .header {
            font-size: 1.1em;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 10px;
        }

        .adaptive-content .ai-message {
            font-size: 1em;
            color: #333;
            line-height: 1.5;
            margin-bottom: 15px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            border: 1px dashed #0056b3;
        }

        /* CSS cho th√¥ng b√°o l·ªói b√™n trong th·∫ª AI */
        .adaptive-content .ai-error-message {
             background: #fff0f0;
             border: 1px dashed #d00;
             color: #d00;
             padding: 12px;
             border-radius: 8px;
        }

        /* Th·∫ª t√†i li·ªáu ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t (n·ªïi b·∫≠t nh·∫•t) */
        .content-card {
            display: block;
            background: #ffffff;
            border-radius: 8px;
            padding: 15px;
            text-decoration: none; /* B·ªè g·∫°ch ch√¢n link */
            color: #222;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        .content-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 50, 150, 0.15);
            border-color: #0056b3;
        }
        .content-card .content-type {
            font-size: 0.8em;
            font-weight: bold;
            color: #0056b3;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .content-card .content-title {
            font-size: 1.1em;
            font-weight: bold;
        }
        .content-card .content-duration {
            font-size: 0.9em;
            color: #777;
            margin-top: 8px;
        }

        /* 3. Tr·∫°ng th√°i Khen ng·ª£i (Congrats) */
        .congrats-message {
            text-align: center;
            font-size: 1.1em;
            color: #006400; /* M√†u xanh l√° */
            font-weight: bold;
            padding: 15px;
            background: #f0fff0;
            border: 1px solid #006400;
            border-radius: 8px;
        }

    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>

        <div class="d-flex align-items-center">
            <span class="navbar-text me-3" id="welcomeMessage"></span>
            <a class="btn btn-outline-light me-2" href="/profile" title="H·ªì s∆° c·ªßa t√¥i">
                <i class="bi bi-person-circle"></i>
            </a>
            <button class="btn btn-outline-light" id="logoutButton" title="ƒêƒÉng xu·∫•t">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h1 class="h3 mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="userNameHeader" class="text-primary"></span>!</h1>

    <div id="studyNotification" class="mb-3">
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="card-title">B·ªô l·ªçc bi·ªÉu ƒë·ªì</h5>
            <form class="row g-3 align-items-end" id="filterForm">
                <div class="col-md-3">
                    <label for="filterType" class="form-label">Xem theo:</label>
                    <select id="filterType" name="filterType" class="form-select">
                        <option value="week" selected>Tu·∫ßn</option>
                        <option value="month">Th√°ng</option>
                        <option value="year">NƒÉm</option>
                    </select>
                </div>

                <div id="filterGroupWeek" class="col-md-6">
                    <label for="filterDate" class="form-label">Ch·ªçn m·ªëc ng√†y (Tu·∫ßn k·∫øt th√∫c v√†o):</label>
                    <input type="date" id="filterDate" name="filterDate" class="form-control">
                </div>

                <div id="filterGroupMonth" class="col-md-6 row g-3" style="display: none;">
                    <div class="col-6">
                        <label for="filterMonth" class="form-label">Ch·ªçn th√°ng:</label>
                        <select id="filterMonth" name="month" class="form-select">
                            <option value="1">Th√°ng 1</option>
                            <option value="2">Th√°ng 2</option>
                            <option value="3">Th√°ng 3</option>
                            <option value="4">Th√°ng 4</option>
                            <option value="5">Th√°ng 5</option>
                            <option value="6">Th√°ng 6</option>
                            <option value="7">Th√°ng 7</option>
                            <option value="8">Th√°ng 8</option>
                            <option value="9">Th√°ng 9</option>
                            <option value="10">Th√°ng 10</option>
                            <option value="11">Th√°ng 11</option>
                            <option value="12">Th√°ng 12</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="filterYearMonth" class="form-label">NƒÉm:</label>
                        <select id="filterYearMonth" name="yearMonth" class="form-select"></select>
                    </div>
                </div>

                <div id="filterGroupYear" class="col-md-6" style="display: none;">
                    <label for="filterYear" class="form-label">Ch·ªçn nƒÉm:</label>
                    <select id="filterYear" name="year" class="form-select"></select>
                </div>

                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel-fill"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-7 mb-3 mb-lg-0">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart-line-fill text-primary"></i> Th·ªùi gian h·ªçc (ph√∫t)</h5>
                    <div id="timeChartLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <canvas id="timeChart" style="display: none;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-pie-chart-fill text-success"></i> Th·ªëng k√™ ho·∫°t ƒë·ªông</h5>
                    <div id="activityChartLoading" class="text-center">
                        <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <canvas id="activityChart" style="display: none; max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-journal-bookmark-fill text-info"></i> M√¥n h·ªçc c·ªßa t√¥i</h2>
    <div class="row" id="mySubjectsList">
        <div class="col-12 text-center" id="mySubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>ƒêang t·∫£i c√°c m√¥n h·ªçc c·ªßa b·∫°n...</p>
        </div>
        <div class="col-12" id="noMySubjects" style="display: none;">
            <div class="alert alert-info">B·∫°n ch∆∞a ƒëƒÉng k√Ω m√¥n h·ªçc n√†o. H√£y kh√°m ph√° c√°c m√¥n h·ªçc b√™n d∆∞·ªõi!</div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-search text-warning"></i> Kh√°m ph√° m√¥n h·ªçc</h2>
    <div class="row" id="exploreSubjectsList">
        <div class="col-12 text-center" id="exploreSubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>ƒêang t·∫£i danh s√°ch m√¥n h·ªçc...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> T·∫°o L·ªô tr√¨nh h·ªçc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planUserSubjectId">

                    <div class="mb-3">
                        <label for="customPrompt" class="form-label">Y√™u c·∫ßu t√πy ch·ªânh:</label>
                        <textarea class="form-control" id="customPrompt" rows="3"
                                  placeholder="V√≠ d·ª•: T·∫≠p trung v√†o th·ª±c h√†nh, ho·∫∑c t·∫°o l·ªô tr√¨nh trong 3 tu·∫ßn..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="planLectureFile" class="form-label">
                            T·∫£i file b√†i gi·∫£ng / slide (tu·ª≥ ch·ªçn)
                        </label>
                        <input class="form-control" type="file" id="planLectureFile"
                               accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
                        <div class="form-text">
                            AI s·∫Ω ƒë·ªçc n·ªôi dung file n√†y ƒë·ªÉ ƒë·ªÅ xu·∫•t l·ªô tr√¨nh s√°t v·ªõi b√†i gi·∫£ng c·ªßa b·∫°n h∆°n.
                        </div>
                    </div>

                    <div id="planResult" class="mt-3 p-3 bg-light border rounded"
                         style="display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="submitPlanButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quizModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-patch-question-fill"></i> T·∫°o Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quizForm">
                    <input type="hidden" id="quizUserSubjectId">

                    <div class="mb-3">
                        <label for="quizTopic" class="form-label">Ch·ªß ƒë·ªÅ Quiz (T√πy ch·ªçn):</label>
                        <input type="text" class="form-control" id="quizTopic"
                               placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1: Gi·ªõi thi·ªáu, ho·∫∑c ƒë·ªÉ tr·ªëng">
                    </div>

                    <div class="mb-3">
                        <label for="quizNumQuestions" class="form-label">S·ªë l∆∞·ª£ng c√¢u h·ªèi:</label>
                        <select class="form-select" id="quizNumQuestions">
                            <option value="5">5 c√¢u</option>
                            <option value="10" selected>10 c√¢u</option>
                            <option value="15">15 c√¢u</option>
                            <option value="20">20 c√¢u</option>
                            <option value="25">25 c√¢u</option>
                            <option value="30">30 c√¢u</option>
                            <option value="35">35 c√¢u</option>
                            <option value="40">40 c√¢u</option>
                            <option value="45">45 c√¢u</option>
                            <option value="50">50 c√¢u</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="quizLectureFile" class="form-label">
                            T·∫£i file b√†i gi·∫£ng ƒë·ªÉ t·∫°o c√¢u h·ªèi (tu·ª≥ ch·ªçn)
                        </label>
                        <input class="form-control" type="file" id="quizLectureFile"
                               accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
                        <div class="form-text">
                            N√™n ch·ªçn ƒë√∫ng slide / ch∆∞∆°ng b·∫°n mu·ªën t·∫°o Quiz ƒë·ªÉ c√¢u h·ªèi s√°t n·ªôi dung nh·∫•t.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" id="submitQuizButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="flashcardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-card-checklist"></i> T·∫°o Flashcard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="flashcardForm">
                    <input type="hidden" id="flashcardUserSubjectId">
                    <div class="mb-3">
                        <label for="flashcardTitle" class="form-label">Ti√™u ƒë·ªÅ b·ªô Flashcard:</label>
                        <input type="text" class="form-control" id="flashcardTitle" required placeholder="V√≠ d·ª•: C√°c thu·∫≠t ng·ªØ Spring Boot">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardTopic" class="form-label">Ch·ªß ƒë·ªÅ (T√πy ch·ªçn):</label>
                        <input type="text" class="form-control" id="flashcardTopic" placeholder="V√≠ d·ª•: Annotations, ho·∫∑c ƒë·ªÉ tr·ªëng">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardNumCards" class="form-label">S·ªë l∆∞·ª£ng th·∫ª:</label>
                        <select class="form-select" id="flashcardNumCards">
                            <option value="10" selected>10 th·∫ª</option>
                            <option value="20">20 th·∫ª</option>
                            <option value="30">30 th·∫ª</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-warning" id="submitFlashcardButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o Flashcard
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="logSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Ghi l·∫°i th·ªùi gian h·ªçc
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logSessionForm">
                    <div class="mb-3">
                        <label for="logSubject" class="form-label">M√¥n h·ªçc</label>
                        <select class="form-select" id="logSubject" required>
                            <option value="" disabled selected>-- Ch·ªçn m√¥n h·ªçc --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="logDuration" class="form-label">
                            Th·ªùi gian h·ªçc (ph√∫t)
                        </label>
                        <input type="number" min="1" class="form-control"
                               id="logDuration" placeholder="V√≠ d·ª•: 30" required>
                    </div>

                    <div class="mb-3">
                        <label for="logDetails" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                        <textarea class="form-control" id="logDetails" rows="3"
                                  placeholder="V√≠ d·ª•: √în l·∫°i Ch∆∞∆°ng 1, l√†m b√†i t·∫≠p √¥n t·∫≠p..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">ƒê√≥ng</button>

                <button type="button"
                        class="btn btn-success"
                        id="submitLogButton">
                    <span class="loading-spinner" role="status"></span>
                    <i class="bi bi-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let currentUserId = null;
    let timeChartInstance = null;
    let activityChartInstance = null;
    let planModal = null;
    let quizModal = null;
    let flashcardModal = null;
    let logSessionModal = null;
    let toastCount = 0;

    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");
        const username = localStorage.getItem("username");
        if (!token) { window.location.href = "/login"; return; }

        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        $("#welcomeMessage").text("Ch√†o, " + username);
        $("#userNameHeader").text(username);
        $("#logoutButton").on("click", logout);

        planModal = new bootstrap.Modal(document.getElementById('planModal'));
        quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
        flashcardModal = new bootstrap.Modal(document.getElementById('flashcardModal'));
        logSessionModal = new bootstrap.Modal(document.getElementById('logSessionModal'));

        setupFilters();

        loadUserData(username);

        $("#submitPlanButton").on("click", handleGeneratePlan);
        $("#submitQuizButton").on("click", handleGenerateQuiz);
        $("#submitFlashcardButton").on("click", handleGenerateFlashcard);
        $("#submitLogButton").on("click", handleLogSession);

        $("#filterForm").on("submit", function(e) {
            e.preventDefault();
            if (currentUserId) {
                loadDashboardData(currentUserId);
            }
        });

        $("#filterType").on("change", handleFilterTypeChange);
    });

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    function setupFilters() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = today.getMonth() + 1;

        $("#filterDate").val(today.toISOString().split('T')[0]);

        $("#filterMonth").val(mm);

        const yearSelects = $("#filterYearMonth, #filterYear");
        yearSelects.empty();
        for (let i = 0; i < 5; i++) {
            const year = yyyy - i;
            yearSelects.append(`<option value="${year}">${year}</option>`);
        }
    }

    function handleFilterTypeChange() {
        const filterType = $("#filterType").val();
        $("#filterGroupWeek").hide();
        $("#filterGroupMonth").hide();
        $("#filterGroupYear").hide();

        if (filterType === 'week') {
            $("#filterGroupWeek").show();
        } else if (filterType === 'month') {
            $("#filterGroupMonth").show();
        } else if (filterType === 'year') {
            $("#filterGroupYear").show();
        }
    }

    function loadUserData(username) {
        $.ajax({
            type: "GET", url: `http://localhost:8080/api/users/${username}`,
            success: function(userDTO) {
                currentUserId = userDTO.userId;
                loadDashboardData(currentUserId);
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    function loadDashboardData(userId) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        // Hi·ªÉn th·ªã loading
        $("#timeChart").hide();
        $("#activityChart").hide();
        $("#timeChartLoading").show();
        $("#activityChartLoading").show();
        $("#studyNotification").empty();

        // 1. L·∫§Y GI√Å TR·ªä T·ª™ B·ªò L·ªåC
        const filterType = $("#filterType").val();
        let filterDate;

        if (filterType === 'week') {
            // L·∫•y t·ª´ √¥ ch·ªçn ng√†y
            filterDate = $("#filterDate").val();
        } else if (filterType === 'month') {
            // Gh√©p th√°ng v√† nƒÉm
            const year = $("#filterYearMonth").val();
            const month = $("#filterMonth").val().padStart(2, '0');
            filterDate = `${year}-${month}-01`; // V√≠ d·ª•: "2025-01-01"
        } else if (filterType === 'year') {
            // L·∫•y t·ª´ √¥ ch·ªçn nƒÉm
            const year = $("#filterYear").val();
            filterDate = `${year}-01-01`; // V√≠ d·ª•: "2025-01-01"
        }

        // 2. G·ª¨I AJAX V·ªöI D·ªÆ LI·ªÜU ƒê√öNG
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/dashboard/${userId}`,
            data: {
                filterType: filterType, // S·∫Ω g·ª≠i "month"
                filterDate: filterDate  // S·∫Ω g·ª≠i "2025-01-01"
            },
            success: function(data) {
                renderTimeChart(data.timeLabels || [], data.timeData || []);
                renderActivityChart(data.activityCounts || {});

                if (data.studyNotification) {
                    $("#studyNotification").html(`<div class="alert alert-info">${data.studyNotification}</div>`);
                }

                $("#timeChart").show();
                $("#activityChart").show();
            },
            error: function(xhr) {
                console.error("L·ªói t·∫£i dashboard:", xhr.responseText);
                $("#studyNotification").html(`<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu dashboard.</div>`);
            },
            complete: function() {
                // ·∫®n loading
                $("#timeChartLoading").hide();
                $("#activityChartLoading").hide();
            }
        });
    }

    async function loadSubjectsAndEnrollments(userId) {
        $("#mySubjectsLoading").show();
        $("#exploreSubjectsLoading").show();
        $("#noMySubjects").hide();

        const mySubjectsListDiv = $("#mySubjectsList");
        const exploreSubjectsListDiv = $("#exploreSubjectsList");
        const logSubjectSelect = $("#logSubject");

        mySubjectsListDiv.empty();
        exploreSubjectsListDiv.empty();
        logSubjectSelect.empty().append('<option value="" disabled selected>-- Ch·ªçn m√¥n h·ªçc --</option>');

        try {
            const enrolledSubjects = await $.ajax({ url: `http://localhost:8080/api/users/${userId}/subjects` });
            const enrolledMap = new Map();

            if (enrolledSubjects.length === 0) {
                $("#noMySubjects").show();
            } else {

                // (Gi·ªØ nguy√™n logic l·∫∑p qua c√°c m√¥n h·ªçc)
                for (const us of enrolledSubjects) {
                    enrolledMap.set(us.subject.subjectId, us.id);

                    const cardHtml = `
                        <div class="col-12 mb-3">
                            <div class="subject-card">
                                <div class="subject-info">
                                    <h5 class="mb-1">${us.subject.subjectName}</h5>
                                    <p class="text-muted progress-text mb-0">
                                        ƒê√£ ƒëƒÉng k√Ω ¬∑ Ti·∫øn ƒë·ªô: <strong>${us.progressPercentage}%</strong>
                                    </p>
                                </div>
                                <div class="subject-actions">
                                    <button class="btn btn-outline-info"
                                            onclick="viewSubjectContent(${us.id})">
                                        <i class="bi bi-book me-1"></i> H·ªçc
                                    </button>
                                    <button class="btn btn-outline-primary"
                                            onclick="openPlanModal(${us.id})">
                                        <i class="bi bi-calendar-check me-1"></i> Plan
                                    </button>
                                    <button class="btn btn-outline-success"
                                            onclick="openQuizModal(${us.id})">
                                        <i class="bi bi-patch-question me-1"></i> Quiz
                                    </button>
                                    <button class="btn btn-outline-warning"
                                            onclick="openFlashcardModal(${us.id})">
                                        <i class="bi bi-card-checklist me-1"></i> Flashcard
                                    </button>
                                </div>
                            </div>
                            <div id="adaptive-card-for-subject-${us.id}" class="adaptive-recommendation-box" style="display: none;">
                                <div class="adaptive-loading">
                                    <div class="spinner"></div>
                                    <p>AI ƒëang ph√¢n t√≠ch ƒëi·ªÉm y·∫øu...</p>
                                </div>
                                <div class="adaptive-content"></div>
                            </div>

                        </div>
                    `;
                    mySubjectsListDiv.append(cardHtml);
                    logSubjectSelect.append(
                        `<option value="${us.id}">${us.subject.subjectName}</option>`
                    );

                    // K√çCH HO·∫†T "B√ÅC Sƒ®" AI CHO M√îN N√ÄY
                    fetchAdaptiveRecommendation(us.id);
                }
            }

            const allSubjects = await $.ajax({ url: "http://localhost:8080/api/subjects" });
            const subjectsToExplore = {};

            allSubjects.forEach(subject => {
                if (!enrolledMap.has(subject.subjectId)) {
                    //... (ph·∫ßn logic Kh√°m ph√° m√¥n h·ªçc gi·ªØ nguy√™n) ...
                    const category = subject.subjectCategory || 'Kh√°c';
                    if (!subjectsToExplore[category]) {
                        subjectsToExplore[category] = [];
                    }
                    subjectsToExplore[category].push(subject);
                }
            });

            if (Object.keys(subjectsToExplore).length === 0) {
                 exploreSubjectsListDiv.append('<div class="col-12"><p class="text-muted">B·∫°n ƒë√£ ƒëƒÉng k√Ω t·∫•t c·∫£ c√°c m√¥n h·ªçc!</p></div>');
            } else {
                for (const categoryName in subjectsToExplore) {

                    const categoryHtml = `
                        <div class="col-12 mt-3">
                            <h4 class="text-muted">${categoryName}</h4>
                            <hr>
                        </div>
                    `;
                    exploreSubjectsListDiv.append(categoryHtml);

                    subjectsToExplore[categoryName].forEach(subject => {
                        const description = subject.description ? subject.description.substring(0, 100) + '...' : '';
                        const cardHtml = `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${subject.subjectName}</h5>
                                        <p class="card-text text-muted">${description}</p>
                                        <div class="mt-auto">
                                            <button class="btn btn-outline-primary w-100" id="enrollBtn-${subject.subjectId}" onclick="enroll(${subject.subjectId})">
                                                <span class="loading-spinner" id="enrollSpinner-${subject.subjectId}"></span>
                                                <i class="bi bi-plus-circle"></i> ƒêƒÉng k√Ω h·ªçc
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        exploreSubjectsListDiv.append(cardHtml);
                    });
                }
            }

        } catch (xhr) {
            console.error("L·ªói khi t·∫£i m√¥n h·ªçc:", xhr.responseText);
            mySubjectsListDiv.html('<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√¥n h·ªçc.</div>');
        } finally {
            $("#mySubjectsLoading").hide();
            $("#exploreSubjectsLoading").hide();
        }
    }

    function enroll(subjectId) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const btn = $(`#enrollBtn-${subjectId}`);
        const spinner = $(`#enrollSpinner-${subjectId}`);
        btn.prop('disabled', true);
        spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/enroll",
            contentType: "application/json",
            data: JSON.stringify({ userId: currentUserId, subjectId: subjectId }),
            success: function(userSubjectDTO) {
                showToast("ƒêƒÉng k√Ω m√¥n h·ªçc th√†nh c√¥ng!");
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                showToast("L·ªói: " + xhr.responseText, "error");
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function openPlanModal(userSubjectId) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        $("#planUserSubjectId").val(userSubjectId);
        $("#planForm")[0].reset();
        $("#planResult").hide().empty();
        $("#submitPlanButton").prop('disabled', false).find(".loading-spinner").hide();
        planModal.show();
    }

    function openQuizModal(userSubjectId) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        $("#quizUserSubjectId").val(userSubjectId);
        $("#quizForm")[0].reset();
        $("#quizResult").hide().empty();
        $("#submitQuizButton").prop('disabled', false).find(".loading-spinner").hide();
        quizModal.show();
    }

    function openFlashcardModal(userSubjectId) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        $("#flashcardUserSubjectId").val(userSubjectId);
        $("#flashcardForm")[0].reset();
        $("#submitFlashcardButton").prop('disabled', false).find(".loading-spinner").hide();
        flashcardModal.show();
    }

    function viewSubjectContent(userSubjectId) {
            // ... (H√†m n√†y gi·ªØ nguy√™n) ...
            window.location.href = "/my-subject/" + userSubjectId;
        }

    function handleGeneratePlan() {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const btn = $("#submitPlanButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true);
        spinner.show();
        $("#planResult").hide().empty();

        const requestObj = {
            userSubjectId: $("#planUserSubjectId").val(),
            customPrompt: $("#customPrompt").val()
        };

        const formData = new FormData();
        formData.append(
            "request",
            new Blob([JSON.stringify(requestObj)], { type: "application/json" })
        );

        const fileInput = $("#planLectureFile")[0];
        if (fileInput.files && fileInput.files[0]) {
            formData.append("lectureFile", fileInput.files[0]);
        }

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/study-plans/generate",
            data: formData,
            processData: false,
            contentType: false,
            success: function(planDTO) {
                $("#planResult").text(planDTO.planContent).show();
                showToast("T·∫°o l·ªô tr√¨nh th√†nh c√¥ng!");
                loadDashboardData(currentUserId);
            },
            error: function(xhr) {
                $("#planResult").text("L·ªói: " + xhr.responseText).show();
            },
            complete: function() {
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function handleGenerateQuiz() {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const btn = $("#submitQuizButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true);
        spinner.show();

        const requestObj = {
            userSubjectId: $("#quizUserSubjectId").val(),
            topic: $("#quizTopic").val() || null,
            numberOfQuestions: $("#quizNumQuestions").val()
        };

        const formData = new FormData();
        formData.append(
            "request",
            new Blob([JSON.stringify(requestObj)], { type: "application/json" })
        );

        const fileInput = $("#quizLectureFile")[0];
        if (fileInput.files && fileInput.files[0]) {
            formData.append("lectureFile", fileInput.files[0]);
        }

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/quizzes/generate",
            data: formData,
            processData: false,
            contentType: false,
            success: function(quizDTO) {
                showToast(`T·∫°o Quiz th√†nh c√¥ng! Chu·∫©n b·ªã l√†m b√†i...`);
                loadDashboardData(currentUserId);

                setTimeout(function() {
                    window.location.href = "/quiz/" + quizDTO.quizId;
                }, 1000);
            },
            error: function(xhr) {
                alert("L·ªói t·∫°o Quiz: " + xhr.responseText);
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function handleGenerateFlashcard() {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const btn = $("#submitFlashcardButton");
        const spinner = btn.find(".loading-spinner");
        const title = $("#flashcardTitle").val();
        if (!title) { alert("Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ!"); return; }

        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/flashcards/generate",
            contentType: "application/json",
            data: JSON.stringify({
                userSubjectId: $("#flashcardUserSubjectId").val(),
                title: title,
                topic: $("#flashcardTopic").val() || null,
                numberOfCards: $("#flashcardNumCards").val()
            }),
            success: function(setDTO) {
                showToast(`T·∫°o th√†nh c√¥ng: "${setDTO.title}"! ƒêang t·∫£i...`);
                loadDashboardData(currentUserId);
                setTimeout(function() {
                    window.location.href = "/flashcards/" + setDTO.setId;
                }, 1000);
            },
            error: function(xhr) {
                alert("L·ªói t·∫°o Flashcard: " + xhr.responseText);
                btn.prop('disabled', false); spinner.hide();
            }
        });
    }

    function handleLogSession() {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const btn = $("#submitLogButton");
        const spinner = btn.find(".loading-spinner");

        const logData = {
            userId: currentUserId,
            userSubjectId: $("#logSubject").val(),
            durationMinutes: $("#logDuration").val(),
            details: $("#logDetails").val() || null
        };

        if (!logData.userSubjectId || !logData.durationMinutes || logData.durationMinutes < 1) {
            alert("Vui l√≤ng ch·ªçn m√¥n h·ªçc v√† nh·∫≠p th·ªùi gian h·ª£p l·ªá (l·ªõn h∆°n 0 ph√∫t).");
            return;
        }

        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/log/session",
            contentType: "application/json",
            data: JSON.stringify(logData),
            success: function() {
                showToast("Ghi l·∫°i th·ªùi gian h·ªçc th√†nh c√¥ng!");
                logSessionModal.hide();
                $("#logSessionForm")[0].reset();

                loadDashboardData(currentUserId);
            },
            error: function(xhr) {
                alert("L·ªói khi log: " + xhr.responseText);
            },
            complete: function() {
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function renderTimeChart(labels, data) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        if(timeChartInstance) timeChartInstance.destroy();
        const ctx = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'S·ªë ph√∫t ƒë√£ h·ªçc', data: data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });
    }

    function renderActivityChart(activityData) {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        if(activityChartInstance) activityChartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        activityChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(activityData), datasets: [{ data: Object.values(activityData), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)', 'rgba(108, 117, 125, 0.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function showToast(message, type = "success") {
        // ... (H√†m n√†y gi·ªØ nguy√™n) ...
        const toastId = "toast-" + (toastCount++);
        const bgClass = type === "success" ? "bg-success" : "bg-danger";

        const toastHtml = `
            <div id="${toastId}" class="toast align-items:center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        $("#toastContainer").append(toastHtml);

        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

    // --- C√ÅC H√ÄM M·ªöI ƒê√É S·ª¨A L·ªñI (B∆Ø·ªöC 3) ---

    /**
     * S·ª¨A L·ªñI: ƒê√£ chuy·ªÉn t·ª´ `fetch` sang `$.ajax`
     * L√Ω do: `fetch` (JavaScript g·ªëc) kh√¥ng t·ª± ƒë·ªông g·ª≠i JWT Token.
     * `$.ajax` (jQuery) s·∫Ω t·ª± ƒë·ªông d√πng `$.ajaxSetup` c·ªßa b·∫°n ƒë·ªÉ g·ª≠i Token.
     * ƒê√¢y l√† l√Ω do b·∫°n nh·∫≠n ƒë∆∞·ª£c "L·ªói API:" (l√† l·ªói 401/403 Unauthorized).
     */
    function fetchAdaptiveRecommendation(userSubjectId) { // B·ªè 'async' v√¨ $.ajax d√πng .done/.fail
        const card = $(`#adaptive-card-for-subject-${userSubjectId}`);
        const loadingBox = card.find('.adaptive-loading');
        const contentBox = card.find('.adaptive-content');

        // Hi·ªÉn th·ªã th·∫ª (ƒëang ·ªü tr·∫°ng th√°i loading)
        card.show();

        $.ajax({
            type: "GET",
            url: `/api/adaptive/recommendation/${userSubjectId}`,
            // Kh√¥ng c·∫ßn 'headers', v√¨ $.ajaxSetup ƒë√£ t·ª± ƒë·ªông th√™m
        })
        .done(function(data) {
            // 1. G·ªåI API TH√ÄNH C√îNG (data l√† JSON tr·∫£ v·ªÅ)
            buildRecommendationUI(card, data);
        })
        .fail(function(xhr) {
            // 2. G·ªåI API TH·∫§T B·∫†I (B·ªã 401, 403, 500...)
            console.error('L·ªói khi l·∫•y ƒë·ªÅ xu·∫•t:', xhr.status, xhr.statusText, xhr.responseText);

            // L√†m cho th√¥ng b√°o l·ªói ƒë·∫πp h∆°n
            let errorMsg = `L·ªói ${xhr.status}: ${xhr.statusText}`;
            if (xhr.status === 401 || xhr.status === 403) {
                errorMsg = "L·ªói x√°c th·ª±c. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";
            } else if (xhr.status === 500) {
                 errorMsg = "L·ªói m√°y ch·ªß khi ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i sau.";
            } else if (xhr.status === 0) {
                 errorMsg = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. API ƒëang ch·∫°y ch·ª©?";
            }

            contentBox.html(`
                <div class="ai-error-message">
                    <strong>Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ xu·∫•t AI.</strong><br>
                    ${errorMsg}
                </div>`);
        })
        .always(function() {
            // 3. LU√îN LU√îN ch·∫°y: ·∫®n "Loading" v√† hi·ªán "N·ªôi dung"
            loadingBox.hide();
            contentBox.show();
        });
    }

    /**
     * "V·∫Ω" HTML "ƒë·∫∑c s·∫Øc" d·ª±a tr√™n DTO tr·∫£ v·ªÅ
     * (H√†m n√†y gi·ªØ nguy√™n t·ª´ code c·ªßa b·∫°n)
     */
    function buildRecommendationUI(cardElement, data) {
        let html = '';
        const contentBox = cardElement.find('.adaptive-content');

        // ----------------------------------------------------
        // TR∆Ø·ªúNG H·ª¢P 1: C√ì ƒê·ªÄ XU·∫§T (K·ªäCH B·∫¢N T·ªêT NH·∫§T)
        // ----------------------------------------------------
        if (data.recommendationProvided) {
            const content = data.recommendedContent;

            // N·∫øu link l√† video youtube, tr√≠ch xu·∫•t ID ƒë·ªÉ t·∫°o thumbnail
            let videoThumbnail = '';
            if (content.contentType === 'VIDEO' && content.urlOrData.includes('youtube.com')) {
                try {
                    const url = new URL(content.urlOrData);
                    const videoId = url.searchParams.get('v');
                    if(videoId) {
                        videoThumbnail = `<img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" class="img-fluid rounded mb-2" alt="Video thumbnail">`;
                    }
                } catch(e) {} // B·ªè qua n·∫øu URL l·ªói
            }

            html = `
                <div class="header">üåü G·ª£i √Ω t·ª´ Tr·ª£ l√Ω AI</div>

                <div class="ai-message">
                    "${data.recommendationText}"
                </div>

                <a href="${content.urlOrData}" target="_blank" class="content-card">
                    ${videoThumbnail} <div class="content-type">
                        ${content.contentType} </div>
                    <div class="content-title">
                        ${content.title} </div>
                    <div class="content-duration">
                        ‚è±Ô∏è ∆Ø·ªõc t√≠nh: ${content.estimatedDurationMinutes} ph√∫t
                    </div>
                </a>
            `;
        }

        // ----------------------------------------------------
        // TR∆Ø·ªúNG H·ª¢P 2: KH√îNG C√ì ƒê·ªÄ XU·∫§T (V√å USER QU√Å GI·ªéI)
        // ----------------------------------------------------
        else {
            // data.recommendationText s·∫Ω l√† l·ªùi khen (n·∫øu kh√¥ng c√≥ l·ªói)
            // ho·∫∑c l√† l·ªùi ƒë·ªông vi√™n (n·∫øu c√≥ l·ªói nh∆∞ng thi·∫øu t√†i li·ªáu)
            html = `
                <div class="header">üéâ Th√¥ng b√°o t·ª´ AI</div>
                <div class="congrats-message">
                    ${data.recommendationText}
                </div>
            `;
        }

        // 4. B∆°m HTML v√†o trang
        contentBox.html(html);
    }


</script>
</body>
</html>