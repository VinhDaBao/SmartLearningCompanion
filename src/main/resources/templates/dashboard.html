<!--<!DOCTYPE html>-->
<!--<html lang="vi" xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Dashboard - Smart Learning</title>-->

<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">-->

<!--    <style>-->
<!--        .loading-spinner { display: none; width: 1.5rem; height: 1.5rem; vertical-align: text-bottom; border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: .75s linear infinite spinner-border; }-->
<!--        .toast-container { z-index: 1100; }-->
<!--    </style>-->
<!--</head>-->
<!--<body class="bg-light">-->

<!--<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">-->
<!--    <div class="container-fluid">-->
<!--        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>-->
<!--        <div class="d-flex align-items-center">-->
<!--            <span class="navbar-text me-3" id="welcomeMessage"></span>-->
<!--            <a class="btn btn-outline-light me-2" href="/profile" title="Hồ sơ của tôi">-->
<!--                <i class="bi bi-person-circle"></i>-->
<!--            </a>-->
<!--            <button class="btn btn-outline-light" id="logoutButton" title="Đăng xuất">-->
<!--                <i class="bi bi-box-arrow-right"></i>-->
<!--            </button>-->
<!--        </div>-->
<!--    </div>-->
<!--</nav>-->

<!--<div class="container mt-4">-->

<!--    <h1 class="h3 mb-2">Chào mừng trở lại, <span id="userNameHeader" class="text-primary"></span>!</h1>-->

<!--    <div id="studyNotification" class="mb-3">-->
<!--    </div>-->

<!--    <div class="card shadow-sm border-0 mb-4">-->
<!--        <div class="card-body">-->
<!--            <h5 class="card-title">Bộ lọc biểu đồ</h5>-->
<!--            <form class="row g-3 align-items-end" id="filterForm">-->
<!--                <div class="col-md-4">-->
<!--                    <label for="filterType" class="form-label">Xem theo:</label>-->
<!--                    <select id="filterType" name="filterType" class="form-select">-->
<!--                        <option value="week" selected>7 ngày qua</option>-->
<!--                        <option value="month">Theo tháng</option>-->
<!--                        <option value="year">Theo năm</option>-->
<!--                    </select>-->
<!--                </div>-->
<!--                <div class="col-md-4">-->
<!--                    <label for="filterDate" class="form-label">Chọn mốc ngày:</label>-->
<!--                    <input type="date" id="filterDate" name="filterDate" class="form-control">-->
<!--                </div>-->
<!--                <div class="col-md-4">-->
<!--                    <button type="submit" class="btn btn-primary w-100">-->
<!--                        <i class="bi bi-funnel-fill"></i> Lọc-->
<!--                    </button>-->
<!--                </div>-->
<!--            </form>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="row mb-4">-->
<!--        <div class="col-lg-7 mb-3 mb-lg-0">-->
<!--            <div class="card shadow-sm border-0 h-100">-->
<!--                <div class="card-body">-->
<!--                    <h5 class="card-title"><i class="bi bi-bar-chart-line-fill text-primary"></i> Thời gian học (phút)</h5>-->
<!--                    <div id="timeChartLoading" class="text-center">-->
<!--                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>-->
<!--                    </div>-->
<!--                    <canvas id="timeChart" style="display: none;"></canvas>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--        <div class="col-lg-5">-->
<!--            <div class="card shadow-sm border-0 h-100">-->
<!--                <div class="card-body">-->
<!--                    <h5 class="card-title"><i class="bi bi-pie-chart-fill text-success"></i> Thống kê hoạt động</h5>-->
<!--                    <div id="activityChartLoading" class="text-center">-->
<!--                        <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>-->
<!--                    </div>-->
<!--                    <canvas id="activityChart" style="display: none; max-height: 250px;"></canvas>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <hr class="my-4">-->
<!--    <h2><i class="bi bi-journal-bookmark-fill text-info"></i> Môn học của tôi</h2>-->
<!--    <div class="row" id="mySubjectsList">-->
<!--        <div class="col-12 text-center" id="mySubjectsLoading">-->
<!--            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>-->
<!--            <p>Đang tải các môn học của bạn...</p>-->
<!--        </div>-->
<!--        <div class="col-12" id="noMySubjects" style="display: none;">-->
<!--            <div class="alert alert-info">Bạn chưa đăng ký môn học nào. Hãy khám phá các môn học bên dưới!</div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <hr class="my-4">-->
<!--    <h2><i class="bi bi-search text-warning"></i> Khám phá môn học</h2>-->
<!--    <div class="row" id="exploreSubjectsList">-->
<!--        <div class="col-12 text-center" id="exploreSubjectsLoading">-->
<!--            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>-->
<!--            <p>Đang tải danh sách môn học...</p>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<div class="modal fade" id="planModal" tabindex="-1">-->
<!--    <div class="modal-dialog">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Tạo Lộ trình học</h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <form id="planForm">-->
<!--                    <input type="hidden" id="planUserSubjectId">-->
<!--                    <div class="mb-3">-->
<!--                        <label for="customPrompt" class="form-label">Yêu cầu tùy chỉnh:</label>-->
<!--                        <textarea class="form-control" id="customPrompt" rows="3" placeholder="Ví dụ: Tập trung vào thực hành, hoặc tạo lộ trình trong 3 tuần..."></textarea>-->
<!--                    </div>-->
<!--                    <div id="planResult" class="mt-3 p-3 bg-light border rounded" style="display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>-->
<!--                </form>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>-->
<!--                <button type="button" class="btn btn-primary" id="submitPlanButton">-->
<!--                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo-->
<!--                </button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<div class="modal fade" id="quizModal" tabindex="-1">-->
<!--    <div class="modal-dialog">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title"><i class="bi bi-patch-question-fill"></i> Tạo Quiz</h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <form id="quizForm">-->
<!--                    <input type="hidden" id="quizUserSubjectId">-->
<!--                    <div class="mb-3">-->
<!--                        <label for="quizTopic" class="form-label">Chủ đề Quiz (Tùy chọn):</label>-->
<!--                        <input type="text" class="form-control" id="quizTopic" placeholder="Ví dụ: Chương 1: Giới thiệu, hoặc để trống">-->
<!--                    </div>-->
<!--                    <div class="mb-3">-->
<!--                        <label for="quizNumQuestions" class="form-label">Số lượng câu hỏi:</label>-->
<!--                        <select class="form-select" id="quizNumQuestions">-->
<!--                            <option value="5">5 câu</option>-->
<!--                            <option value="10" selected>10 câu</option>-->
<!--                            <option value="15">15 câu</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                </form>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>-->
<!--                <button type="button" class="btn btn-success" id="submitQuizButton">-->
<!--                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo Quiz-->
<!--                </button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<div class="modal fade" id="flashcardModal" tabindex="-1">-->
<!--    <div class="modal-dialog">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title"><i class="bi bi-card-checklist"></i> Tạo Flashcard</h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <form id="flashcardForm">-->
<!--                    <input type="hidden" id="flashcardUserSubjectId">-->
<!--                    <div class="mb-3">-->
<!--                        <label for="flashcardTitle" class="form-label">Tiêu đề bộ Flashcard:</label>-->
<!--                        <input type="text" class="form-control" id="flashcardTitle" required placeholder="Ví dụ: Các thuật ngữ Spring Boot">-->
<!--                    </div>-->
<!--                    <div class="mb-3">-->
<!--                        <label for="flashcardTopic" class="form-label">Chủ đề (Tùy chọn):</label>-->
<!--                        <input type="text" class="form-control" id="flashcardTopic" placeholder="Ví dụ: Annotations, hoặc để trống">-->
<!--                    </div>-->
<!--                    <div class="mb-3">-->
<!--                        <label for="flashcardNumCards" class="form-label">Số lượng thẻ:</label>-->
<!--                        <select class="form-select" id="flashcardNumCards">-->
<!--                            <option value="10" selected>10 thẻ</option>-->
<!--                            <option value="20">20 thẻ</option>-->
<!--                            <option value="30">30 thẻ</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                </form>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>-->
<!--                <button type="button" class="btn btn-warning" id="submitFlashcardButton">-->
<!--                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo Flashcard-->
<!--                </button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">-->
<!--</div>-->


<!--<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->

<!--<script>-->
<!--    let currentUserId = null;-->
<!--    let timeChartInstance = null;-->
<!--    let activityChartInstance = null;-->
<!--    let planModal = null;-->
<!--    let quizModal = null;-->
<!--    let flashcardModal = null;-->
<!--    let toastCount = 0;-->

<!--    $(document).ready(function() {-->
<!--        const token = localStorage.getItem("jwtToken");-->
<!--        const username = localStorage.getItem("username");-->
<!--        if (!token) { window.location.href = "/login"; return; }-->

<!--        $.ajaxSetup({-->
<!--            beforeSend: function(xhr) {-->
<!--                xhr.setRequestHeader('Authorization', 'Bearer ' + token);-->
<!--            }-->
<!--        });-->

<!--        $("#welcomeMessage").text("Chào, " + username);-->
<!--        $("#userNameHeader").text(username);-->
<!--        $("#logoutButton").on("click", logout);-->

<!--        planModal = new bootstrap.Modal(document.getElementById('planModal'));-->
<!--        quizModal = new bootstrap.Modal(document.getElementById('quizModal'));-->
<!--        flashcardModal = new bootstrap.Modal(document.getElementById('flashcardModal'));-->

<!--        $("#filterDate").val(new Date().toISOString().split('T')[0]);-->

<!--        loadUserData(username);-->

<!--        $("#filterForm").on("submit", function(e) {-->
<!--            e.preventDefault();-->
<!--            if (currentUserId) {-->
<!--                loadDashboardData(currentUserId);-->
<!--            }-->
<!--        });-->

<!--        $("#submitPlanButton").on("click", handleGeneratePlan);-->
<!--        $("#submitQuizButton").on("click", handleGenerateQuiz);-->
<!--        $("#submitFlashcardButton").on("click", handleGenerateFlashcard);-->
<!--    });-->

<!--    function logout() {-->
<!--        localStorage.removeItem("jwtToken");-->
<!--        localStorage.removeItem("username");-->
<!--        window.location.href = "/login";-->
<!--    }-->

<!--    function loadUserData(username) {-->
<!--        $.ajax({-->
<!--            type: "GET", url: `http://localhost:8080/api/users/${username}`,-->
<!--            success: function(userDTO) {-->
<!--                currentUserId = userDTO.userId;-->
<!--                loadDashboardData(currentUserId);-->
<!--                loadSubjectsAndEnrollments(currentUserId);-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                if (xhr.status === 401 || xhr.status === 403) logout();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    function loadDashboardData(userId) {-->
<!--        const filterType = $("#filterType").val();-->
<!--        const filterDate = $("#filterDate").val();-->

<!--        $("#timeChart").hide();-->
<!--        $("#activityChart").hide();-->
<!--        $("#timeChartLoading").show();-->
<!--        $("#activityChartLoading").show();-->
<!--        $("#studyNotification").empty();-->

<!--        $.ajax({-->
<!--            type: "GET",-->
<!--            url: `http://localhost:8080/api/dashboard/${userId}`,-->
<!--            data: {-->
<!--                filterType: filterType,-->
<!--                filterDate: filterDate-->
<!--            },-->
<!--            success: function(data) {-->
<!--                renderTimeChart(data.timeLabels || [], data.timeData || []);-->
<!--                renderActivityChart(data.activityCounts || {});-->

<!--                if (data.studyNotification) {-->
<!--                    $("#studyNotification").html(`<div class="alert alert-info">${data.studyNotification}</div>`);-->
<!--                }-->

<!--                $("#timeChart").show();-->
<!--                $("#activityChart").show();-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                console.error("Lỗi tải dashboard:", xhr.responseText);-->
<!--                $("#studyNotification").html(`<div class="alert alert-danger">Không thể tải dữ liệu dashboard.</div>`);-->
<!--            },-->
<!--            complete: function() {-->
<!--                $("#timeChartLoading").hide();-->
<!--                $("#activityChartLoading").hide();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    async function loadSubjectsAndEnrollments(userId) {-->
<!--        $("#mySubjectsLoading").show();-->
<!--        $("#exploreSubjectsLoading").show();-->
<!--        $("#noMySubjects").hide();-->

<!--        const mySubjectsListDiv = $("#mySubjectsList");-->
<!--        const exploreSubjectsListDiv = $("#exploreSubjectsList");-->

<!--        mySubjectsListDiv.empty();-->
<!--        exploreSubjectsListDiv.empty();-->

<!--        try {-->
<!--            const enrolledSubjects = await $.ajax({ url: `http://localhost:8080/api/users/${userId}/subjects` });-->
<!--            const enrolledMap = new Map();-->

<!--            if (enrolledSubjects.length === 0) {-->
<!--                $("#noMySubjects").show();-->
<!--            } else {-->
<!--                enrolledSubjects.forEach(us => {-->
<!--                    enrolledMap.set(us.subject.subjectId, us.id);-->

<!--                    const cardHtml = `-->
<!--                        <div class="col-md-6 col-lg-4 mb-4">-->
<!--                            <div class="card shadow-sm border-0 h-100">-->
<!--                                <div class="card-body d-flex flex-column">-->
<!--                                    <h5 class="card-title">${us.subject.subjectName}</h5>-->
<!--                                    <p class="card-text text-muted">Đã đăng ký. Tiến độ: ${us.progressPercentage}%</p>-->
<!--                                    <div class="mt-auto d-grid gap-2 d-sm-block">-->
<!--                                        <button class="btn btn-info btn-sm me-1" onclick="viewSubjectContent(${us.id})">-->
<!--                                            <i class="bi bi-book"></i> Học-->
<!--                                        </button>-->
<!--                                        <button class="btn btn-primary btn-sm me-1" onclick="openPlanModal(${us.id})">-->
<!--                                            <i class="bi bi-calendar-check"></i> Plan-->
<!--                                        </button>-->
<!--                                        <button class="btn btn-success btn-sm me-1" onclick="openQuizModal(${us.id})">-->
<!--                                            <i class="bi bi-patch-question"></i> Quiz-->
<!--                                        </button>-->
<!--                                        <button class="btn btn-warning btn-sm" onclick="openFlashcardModal(${us.id})">-->
<!--                                            <i class="bi bi-card-checklist"></i> Flashcard-->
<!--                                        </button>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    `;-->
<!--                    mySubjectsListDiv.append(cardHtml);-->
<!--                });-->
<!--            }-->

<!--            const allSubjects = await $.ajax({ url: "http://localhost:8080/api/subjects" });-->

<!--            allSubjects.forEach(subject => {-->
<!--                if (!enrolledMap.has(subject.subjectId)) {-->
<!--                    const cardHtml = `-->
<!--                        <div class="col-md-6 col-lg-4 mb-4">-->
<!--                            <div class="card shadow-sm border-0 h-100">-->
<!--                                <div class="card-body d-flex flex-column">-->
<!--                                    <h5 class="card-title">${subject.subjectName}</h5>-->
<!--                                    <p class="card-text text-muted">${subject.description.substring(0, 100)}...</p>-->
<!--                                    <div class="mt-auto">-->
<!--                                        <button class="btn btn-outline-primary w-100" id="enrollBtn-${subject.subjectId}" onclick="enroll(${subject.subjectId})">-->
<!--                                            <span class="loading-spinner" id="enrollSpinner-${subject.subjectId}"></span>-->
<!--                                            <i class="bi bi-plus-circle"></i> Đăng ký học-->
<!--                                        </button>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    `;-->
<!--                    exploreSubjectsListDiv.append(cardHtml);-->
<!--                }-->
<!--            });-->

<!--        } catch (xhr) {-->
<!--            console.error("Lỗi khi tải môn học:", xhr.responseText);-->
<!--            mySubjectsListDiv.html('<div class="alert alert-danger">Không thể tải danh sách môn học.</div>');-->
<!--        } finally {-->
<!--            $("#mySubjectsLoading").hide();-->
<!--            $("#exploreSubjectsLoading").hide();-->
<!--        }-->
<!--    }-->

<!--    function enroll(subjectId) {-->
<!--        const btn = $(`#enrollBtn-${subjectId}`);-->
<!--        const spinner = $(`#enrollSpinner-${subjectId}`);-->
<!--        btn.prop('disabled', true);-->
<!--        spinner.show();-->

<!--        $.ajax({-->
<!--            type: "POST", url: "http://localhost:8080/api/enroll",-->
<!--            contentType: "application/json",-->
<!--            data: JSON.stringify({ userId: currentUserId, subjectId: subjectId }),-->
<!--            success: function(userSubjectDTO) {-->
<!--                showToast("Đăng ký môn học thành công!");-->
<!--                loadSubjectsAndEnrollments(currentUserId);-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                showToast("Lỗi: " + xhr.responseText, "error");-->
<!--                btn.prop('disabled', false);-->
<!--                spinner.hide();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    function openPlanModal(userSubjectId) {-->
<!--        $("#planUserSubjectId").val(userSubjectId);-->
<!--        $("#planForm")[0].reset();-->
<!--        $("#planResult").hide().empty();-->
<!--        $("#submitPlanButton").prop('disabled', false).find(".loading-spinner").hide();-->
<!--        planModal.show();-->
<!--    }-->

<!--    function openQuizModal(userSubjectId) {-->
<!--        $("#quizUserSubjectId").val(userSubjectId);-->
<!--        $("#quizForm")[0].reset();-->
<!--        $("#quizResult").hide().empty();-->
<!--        $("#submitQuizButton").prop('disabled', false).find(".loading-spinner").hide();-->
<!--        quizModal.show();-->
<!--    }-->

<!--    function openFlashcardModal(userSubjectId) {-->
<!--        $("#flashcardUserSubjectId").val(userSubjectId);-->
<!--        $("#flashcardForm")[0].reset();-->
<!--        $("#submitFlashcardButton").prop('disabled', false).find(".loading-spinner").hide();-->
<!--        flashcardModal.show();-->
<!--    }-->

<!--    function viewSubjectContent(userSubjectId) {-->
<!--            window.location.href = "/my-subject/" + userSubjectId;-->
<!--        }-->

<!--    function handleGeneratePlan() {-->
<!--        const btn = $("#submitPlanButton");-->
<!--        const spinner = btn.find(".loading-spinner");-->
<!--        btn.prop('disabled', true); spinner.show();-->
<!--        $("#planResult").hide().empty();-->

<!--        $.ajax({-->
<!--            type: "POST", url: "http://localhost:8080/api/study-plans/generate",-->
<!--            contentType: "application/json",-->
<!--            data: JSON.stringify({-->
<!--                userSubjectId: $("#planUserSubjectId").val(),-->
<!--                customPrompt: $("#customPrompt").val()-->
<!--            }),-->
<!--            success: function(planDTO) {-->
<!--                $("#planResult").text(planDTO.planContent).show();-->
<!--                showToast("Tạo lộ trình thành công!");-->
<!--                loadDashboardData(currentUserId);-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                $("#planResult").text("Lỗi: " + xhr.responseText).show();-->
<!--            },-->
<!--            complete: function() { btn.prop('disabled', false); spinner.hide(); }-->
<!--        });-->
<!--    }-->

<!--    function handleGenerateQuiz() {-->
<!--        const btn = $("#submitQuizButton");-->
<!--        const spinner = btn.find(".loading-spinner");-->
<!--        btn.prop('disabled', true); spinner.show();-->

<!--        $.ajax({-->
<!--            type: "POST", url: "http://localhost:8080/api/quizzes/generate",-->
<!--            contentType: "application/json",-->
<!--            data: JSON.stringify({-->
<!--                userSubjectId: $("#quizUserSubjectId").val(),-->
<!--                topic: $("#quizTopic").val() || null,-->
<!--                numberOfQuestions: $("#quizNumQuestions").val()-->
<!--            }),-->
<!--            success: function(quizDTO) {-->
<!--                showToast(`Tạo Quiz thành công! Chuẩn bị làm bài...`);-->
<!--                loadDashboardData(currentUserId);-->
<!--                setTimeout(function() {-->
<!--                    window.location.href = "/quiz/" + quizDTO.quizId;-->
<!--                }, 1000);-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                alert("Lỗi tạo Quiz: " + xhr.responseText);-->
<!--                btn.prop('disabled', false); spinner.hide();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    function handleGenerateFlashcard() {-->
<!--        const btn = $("#submitFlashcardButton");-->
<!--        const spinner = btn.find(".loading-spinner");-->
<!--        const title = $("#flashcardTitle").val();-->
<!--        if (!title) { alert("Vui lòng nhập Tiêu đề!"); return; }-->

<!--        btn.prop('disabled', true); spinner.show();-->

<!--        $.ajax({-->
<!--            type: "POST", url: "http://localhost:8080/api/flashcards/generate",-->
<!--            contentType: "application/json",-->
<!--            data: JSON.stringify({-->
<!--                userSubjectId: $("#flashcardUserSubjectId").val(),-->
<!--                title: title,-->
<!--                topic: $("#flashcardTopic").val() || null,-->
<!--                numberOfCards: $("#flashcardNumCards").val()-->
<!--            }),-->
<!--            success: function(setDTO) {-->
<!--                showToast(`Tạo thành công: "${setDTO.title}"! Đang tải...`);-->
<!--                loadDashboardData(currentUserId);-->
<!--                setTimeout(function() {-->
<!--                    window.location.href = "/flashcards/" + setDTO.setId;-->
<!--                }, 1000);-->
<!--            },-->
<!--            error: function(xhr) {-->
<!--                alert("Lỗi tạo Flashcard: " + xhr.responseText);-->
<!--                btn.prop('disabled', false); spinner.hide();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    function renderTimeChart(labels, data) {-->
<!--        if(timeChartInstance) timeChartInstance.destroy();-->
<!--        const ctx = document.getElementById('timeChart').getContext('2d');-->
<!--        timeChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Số phút đã học', data: data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });-->
<!--    }-->
<!--    function renderActivityChart(activityData) {-->
<!--        if(activityChartInstance) activityChartInstance.destroy();-->
<!--        const ctx = document.getElementById('activityChart').getContext('2d');-->
<!--        activityChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(activityData), datasets: [{ data: Object.values(activityData), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });-->
<!--    }-->

<!--    function showToast(message, type = "success") {-->
<!--        const toastId = "toast-" + (toastCount++);-->
<!--        const bgClass = type === "success" ? "bg-success" : "bg-danger";-->

<!--        const toastHtml = `-->
<!--            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">-->
<!--                <div class="d-flex">-->
<!--                    <div class="toast-body">-->
<!--                        <i class="bi bi-check-circle-fill"></i> ${message}-->
<!--                    </div>-->
<!--                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>-->
<!--                </div>-->
<!--            </div>-->
<!--        `;-->

<!--        $("#toastContainer").append(toastHtml);-->

<!--        const toastElement = new bootstrap.Toast(document.getElementById(toastId));-->
<!--        toastElement.show();-->

<!--        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {-->
<!--            $(this).remove();-->
<!--        });-->
<!--    }-->

<!--</script>-->
<!--</body>-->
<!--</html>-->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        .loading-spinner { display: none; width: 1.5rem; height: 1.5rem; vertical-align: text-bottom; border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: .75s linear infinite spinner-border; }
        .toast-container { z-index: 1100; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <div class="d-flex align-items-center">
            <span class="navbar-text me-3" id="welcomeMessage"></span>
            <a class="btn btn-outline-light me-2" href="/profile" title="Hồ sơ của tôi">
                <i class="bi bi-person-circle"></i>
            </a>
            <button class="btn btn-outline-light" id="logoutButton" title="Đăng xuất">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h1 class="h3 mb-2">Chào mừng trở lại, <span id="userNameHeader" class="text-primary"></span>!</h1>

    <div id="studyNotification" class="mb-3">
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="card-title">Bộ lọc biểu đồ</h5>
            <form class="row g-3 align-items-end" id="filterForm">
                <div class="col-md-4">
                    <label for="filterType" class="form-label">Xem theo:</label>
                    <select id="filterType" name="filterType" class="form-select">
                        <option value="week" selected>7 ngày qua</option>
                        <option value="month">Theo tháng</option>
                        <option value="year">Theo năm</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filterDate" class="form-label">Chọn mốc ngày:</label>
                    <input type="date" id="filterDate" name="filterDate" class="form-control">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel-fill"></i> Lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-7 mb-3 mb-lg-0">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart-line-fill text-primary"></i> Thời gian học (phút)</h5>
                    <div id="timeChartLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <canvas id="timeChart" style="display: none;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-pie-chart-fill text-success"></i> Thống kê hoạt động</h5>
                    <div id="activityChartLoading" class="text-center">
                        <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <canvas id="activityChart" style="display: none; max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-journal-bookmark-fill text-info"></i> Môn học của tôi</h2>
    <div class="row" id="mySubjectsList">
        <div class="col-12 text-center" id="mySubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>Đang tải các môn học của bạn...</p>
        </div>
        <div class="col-12" id="noMySubjects" style="display: none;">
            <div class="alert alert-info">Bạn chưa đăng ký môn học nào. Hãy khám phá các môn học bên dưới!</div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-search text-warning"></i> Khám phá môn học</h2>
    <div class="row" id="exploreSubjectsList">
        <div class="col-12 text-center" id="exploreSubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>Đang tải danh sách môn học...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Tạo Lộ trình học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planUserSubjectId">
                    <div class="mb-3">
                        <label for="customPrompt" class="form-label">Yêu cầu tùy chỉnh:</label>
                        <textarea class="form-control" id="customPrompt" rows="3" placeholder="Ví dụ: Tập trung vào thực hành, hoặc tạo lộ trình trong 3 tuần..."></textarea>
                    </div>
                    <div id="planResult" class="mt-3 p-3 bg-light border rounded" style="display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="submitPlanButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quizModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-patch-question-fill"></i> Tạo Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quizForm">
                    <input type="hidden" id="quizUserSubjectId">
                    <div class="mb-3">
                        <label for="quizTopic" class="form-label">Chủ đề Quiz (Tùy chọn):</label>
                        <input type="text" class="form-control" id="quizTopic" placeholder="Ví dụ: Chương 1: Giới thiệu, hoặc để trống">
                    </div>
                    <div class="mb-3">
                        <label for="quizNumQuestions" class="form-label">Số lượng câu hỏi:</label>
                        <select class="form-select" id="quizNumQuestions">
                            <option value="5">5 câu</option>
                            <option value="10" selected>10 câu</option>
                            <option value="15">15 câu</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" id="submitQuizButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="flashcardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-card-checklist"></i> Tạo Flashcard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="flashcardForm">
                    <input type="hidden" id="flashcardUserSubjectId">
                    <div class="mb-3">
                        <label for="flashcardTitle" class="form-label">Tiêu đề bộ Flashcard:</label>
                        <input type="text" class="form-control" id="flashcardTitle" required placeholder="Ví dụ: Các thuật ngữ Spring Boot">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardTopic" class="form-label">Chủ đề (Tùy chọn):</label>
                        <input type="text" class="form-control" id="flashcardTopic" placeholder="Ví dụ: Annotations, hoặc để trống">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardNumCards" class="form-label">Số lượng thẻ:</label>
                        <select class="form-select" id="flashcardNumCards">
                            <option value="10" selected>10 thẻ</option>
                            <option value="20">20 thẻ</option>
                            <option value="30">30 thẻ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-warning" id="submitFlashcardButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> Tạo Flashcard
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let currentUserId = null;
    let timeChartInstance = null;
    let activityChartInstance = null;
    let planModal = null;
    let quizModal = null;
    let flashcardModal = null;
    let toastCount = 0;

    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");
        const username = localStorage.getItem("username");
        if (!token) { window.location.href = "/login"; return; }

        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        $("#welcomeMessage").text("Chào, " + username);
        $("#userNameHeader").text(username);
        $("#logoutButton").on("click", logout);

        planModal = new bootstrap.Modal(document.getElementById('planModal'));
        quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
        flashcardModal = new bootstrap.Modal(document.getElementById('flashcardModal'));

        $("#filterDate").val(new Date().toISOString().split('T')[0]);

        loadUserData(username);

        $("#filterForm").on("submit", function(e) {
            e.preventDefault();
            if (currentUserId) {
                loadDashboardData(currentUserId);
            }
        });

        $("#submitPlanButton").on("click", handleGeneratePlan);
        $("#submitQuizButton").on("click", handleGenerateQuiz);
        $("#submitFlashcardButton").on("click", handleGenerateFlashcard);
    });

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    function loadUserData(username) {
        $.ajax({
            type: "GET", url: `http://localhost:8080/api/users/${username}`,
            success: function(userDTO) {
                currentUserId = userDTO.userId;
                loadDashboardData(currentUserId);
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    function loadDashboardData(userId) {
        const filterType = $("#filterType").val();
        const filterDate = $("#filterDate").val();

        $("#timeChart").hide();
        $("#activityChart").hide();
        $("#timeChartLoading").show();
        $("#activityChartLoading").show();
        $("#studyNotification").empty();

        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/dashboard/${userId}`,
            data: {
                filterType: filterType,
                filterDate: filterDate
            },
            success: function(data) {
                renderTimeChart(data.timeLabels || [], data.timeData || []);
                renderActivityChart(data.activityCounts || {});

                if (data.studyNotification) {
                    $("#studyNotification").html(`<div class="alert alert-info">${data.studyNotification}</div>`);
                }

                $("#timeChart").show();
                $("#activityChart").show();
            },
            error: function(xhr) {
                console.error("Lỗi tải dashboard:", xhr.responseText);
                $("#studyNotification").html(`<div class="alert alert-danger">Không thể tải dữ liệu dashboard.</div>`);
            },
            complete: function() {
                $("#timeChartLoading").hide();
                $("#activityChartLoading").hide();
            }
        });
    }

    async function loadSubjectsAndEnrollments(userId) {
        $("#mySubjectsLoading").show();
        $("#exploreSubjectsLoading").show();
        $("#noMySubjects").hide();

        const mySubjectsListDiv = $("#mySubjectsList");
        const exploreSubjectsListDiv = $("#exploreSubjectsList");

        mySubjectsListDiv.empty();
        exploreSubjectsListDiv.empty();

        try {
            const enrolledSubjects = await $.ajax({ url: `http://localhost:8080/api/users/${userId}/subjects` });
            const enrolledMap = new Map();

            if (enrolledSubjects.length === 0) {
                $("#noMySubjects").show();
            } else {
                enrolledSubjects.forEach(us => {
                    enrolledMap.set(us.subject.subjectId, us.id);

                    const cardHtml = `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${us.subject.subjectName}</h5>
                                    <p class="card-text text-muted">Đã đăng ký. Tiến độ: ${us.progressPercentage}%</p>
                                    <div class="mt-auto d-grid gap-2 d-sm-block">
                                        <button class="btn btn-info btn-sm me-1" onclick="viewSubjectContent(${us.id})">
                                            <i class="bi bi-book"></i> Học
                                        </button>
                                        <button class="btn btn-primary btn-sm me-1" onclick="openPlanModal(${us.id})">
                                            <i class="bi bi-calendar-check"></i> Plan
                                        </button>
                                        <button class="btn btn-success btn-sm me-1" onclick="openQuizModal(${us.id})">
                                            <i class="bi bi-patch-question"></i> Quiz
                                        </button>
                                        <button class="btn btn-warning btn-sm" onclick="openFlashcardModal(${us.id})">
                                            <i class="bi bi-card-checklist"></i> Flashcard
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    mySubjectsListDiv.append(cardHtml);
                });
            }

            const allSubjects = await $.ajax({ url: "http://localhost:8080/api/subjects" });

            const subjectsToExplore = {};

            allSubjects.forEach(subject => {
                if (!enrolledMap.has(subject.subjectId)) {

                    const category = subject.subjectCategory || 'Khác';

                    if (!subjectsToExplore[category]) {
                        subjectsToExplore[category] = [];
                    }

                    subjectsToExplore[category].push(subject);
                }
            });

            if (Object.keys(subjectsToExplore).length === 0) {
                exploreSubjectsListDiv.append('<div class="col-12"><p class="text-muted">Bạn đã đăng ký tất cả các môn học!</p></div>');
            } else {
                for (const categoryName in subjectsToExplore) {

                    const categoryHtml = `
                        <div class="col-12 mt-3">
                            <h4 class="text-muted">${categoryName}</h4>
                            <hr>
                        </div>
                    `;
                    exploreSubjectsListDiv.append(categoryHtml);

                    subjectsToExplore[categoryName].forEach(subject => {
                        const description = subject.description ? subject.description.substring(0, 100) + '...' : '';
                        const cardHtml = `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${subject.subjectName}</h5>
                                        <p class="card-text text-muted">${description}</p>
                                        <div class="mt-auto">
                                            <button class="btn btn-outline-primary w-100" id="enrollBtn-${subject.subjectId}" onclick="enroll(${subject.subjectId})">
                                                <span class="loading-spinner" id="enrollSpinner-${subject.subjectId}"></span>
                                                <i class="bi bi-plus-circle"></i> Đăng ký học
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        exploreSubjectsListDiv.append(cardHtml);
                    });
                }
            }

        } catch (xhr) {
            console.error("Lỗi khi tải môn học:", xhr.responseText);
            mySubjectsListDiv.html('<div class="alert alert-danger">Không thể tải danh sách môn học.</div>');
        } finally {
            $("#mySubjectsLoading").hide();
            $("#exploreSubjectsLoading").hide();
        }
    }

    function enroll(subjectId) {
        const btn = $(`#enrollBtn-${subjectId}`);
        const spinner = $(`#enrollSpinner-${subjectId}`);
        btn.prop('disabled', true);
        spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/enroll",
            contentType: "application/json",
            data: JSON.stringify({ userId: currentUserId, subjectId: subjectId }),
            success: function(userSubjectDTO) {
                showToast("Đăng ký môn học thành công!");
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                showToast("Lỗi: " + xhr.responseText, "error");
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function openPlanModal(userSubjectId) {
        $("#planUserSubjectId").val(userSubjectId);
        $("#planForm")[0].reset();
        $("#planResult").hide().empty();
        $("#submitPlanButton").prop('disabled', false).find(".loading-spinner").hide();
        planModal.show();
    }

    function openQuizModal(userSubjectId) {
        $("#quizUserSubjectId").val(userSubjectId);
        $("#quizForm")[0].reset();
        $("#quizResult").hide().empty();
        $("#submitQuizButton").prop('disabled', false).find(".loading-spinner").hide();
        quizModal.show();
    }

    function openFlashcardModal(userSubjectId) {
        $("#flashcardUserSubjectId").val(userSubjectId);
        $("#flashcardForm")[0].reset();
        $("#submitFlashcardButton").prop('disabled', false).find(".loading-spinner").hide();
        flashcardModal.show();
    }

    function viewSubjectContent(userSubjectId) {
            window.location.href = "/my-subject/" + userSubjectId;
        }

    function handleGeneratePlan() {
        const btn = $("#submitPlanButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true); spinner.show();
        $("#planResult").hide().empty();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/study-plans/generate",
            contentType: "application/json",
            data: JSON.stringify({
                userSubjectId: $("#planUserSubjectId").val(),
                customPrompt: $("#customPrompt").val()
            }),
            success: function(planDTO) {
                $("#planResult").text(planDTO.planContent).show();
                showToast("Tạo lộ trình thành công!");
                loadDashboardData(currentUserId);
            },
            error: function(xhr) {
                $("#planResult").text("Lỗi: " + xhr.responseText).show();
            },
            complete: function() { btn.prop('disabled', false); spinner.hide(); }
        });
    }

    function handleGenerateQuiz() {
        const btn = $("#submitQuizButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/quizzes/generate",
            contentType: "application/json",
            data: JSON.stringify({
                userSubjectId: $("#quizUserSubjectId").val(),
                topic: $("#quizTopic").val() || null,
                numberOfQuestions: $("#quizNumQuestions").val()
            }),
            success: function(quizDTO) {
                showToast(`Tạo Quiz thành công! Chuẩn bị làm bài...`);
                loadDashboardData(currentUserId);
                setTimeout(function() {
                    window.location.href = "/quiz/" + quizDTO.quizId;
                }, 1000);
            },
            error: function(xhr) {
                alert("Lỗi tạo Quiz: " + xhr.responseText);
                btn.prop('disabled', false); spinner.hide();
            }
        });
    }

    function handleGenerateFlashcard() {
        const btn = $("#submitFlashcardButton");
        const spinner = btn.find(".loading-spinner");
        const title = $("#flashcardTitle").val();
        if (!title) { alert("Vui lòng nhập Tiêu đề!"); return; }

        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/flashcards/generate",
            contentType: "application/json",
            data: JSON.stringify({
                userSubjectId: $("#flashcardUserSubjectId").val(),
                title: title,
                topic: $("#flashcardTopic").val() || null,
                numberOfCards: $("#flashcardNumCards").val()
            }),
            success: function(setDTO) {
                showToast(`Tạo thành công: "${setDTO.title}"! Đang tải...`);
                loadDashboardData(currentUserId);
                setTimeout(function() {
                    window.location.href = "/flashcards/" + setDTO.setId;
                }, 1000);
            },
            error: function(xhr) {
                alert("Lỗi tạo Flashcard: " + xhr.responseText);
                btn.prop('disabled', false); spinner.hide();
            }
        });
    }

    function renderTimeChart(labels, data) {
        if(timeChartInstance) timeChartInstance.destroy();
        const ctx = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Số phút đã học', data: data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });
    }
    function renderActivityChart(activityData) {
        if(activityChartInstance) activityChartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        activityChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(activityData), datasets: [{ data: Object.values(activityData), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function showToast(message, type = "success") {
        const toastId = "toast-" + (toastCount++);
        const bgClass = type === "success" ? "bg-success" : "bg-danger";

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        $("#toastContainer").append(toastHtml);

        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

</script>
</body>
</html>