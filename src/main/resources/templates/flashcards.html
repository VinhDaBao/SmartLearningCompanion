<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Flashcard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f0f2f5;
        }
        /* --- CSS CHO HIỆU ỨNG LẬT THẺ 3D --- */
        .card-container {
            width: 100%;
            max-width: 600px;
            height: 350px;
            perspective: 1000px; /* Tạo chiều sâu 3D */
            margin: 20px auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d; /* Giữ 3D */
            transition: transform 0.6s;
            cursor: pointer;
        }
        /* Khi bấm (thêm class 'is-flipped'), thẻ sẽ lật */
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Ẩn mặt sau */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card-front { background-color: #fff; border: 1px solid #ddd; }
        .card-back { background-color: #0d6efd; color: white; transform: rotateY(180deg); }
        .review-navigation {
            display: none; max-width: 600px;
            margin: 0 auto; padding-top: 15px;
        }
        /* Mặt sau (lật ngược lại) */
        .card-back {
            background-color: #0d6efd;
            color: white;
            transform: rotateY(180deg);
        }
        /* --- HẾT CSS 3D --- */

        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-warning shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand text-dark" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <h4 class="navbar-text text-dark mb-0" id="setTitle">Đang tải...</h4>
        <a class="btn btn-outline-dark" id="backButton" href="#">
            <i class="bi bi-arrow-left-circle"></i> Quay lại
        </a>
    </div>
</nav>

<div class="container">

    <div id="pageLoading" class="text-center mt-5">
        <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div>
        <h4 class="mt-3">Đang tải bộ thẻ...</h4>
    </div>

    <div id="sessionComplete" class="text-center card shadow-sm p-4">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
        <h2 class="mt-3">Tuyệt vời!</h2>
        <p class="lead">Bạn đã hoàn thành phiên học này.</p>
        <a href="/dashboard" class="btn btn-primary mt-2">Quay về Dashboard</a>
    </div>

    <div id="mainContent" style="display: none;">

        <div class="card-container" id="cardContainer">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front" id="cardFront">
                    Mặt trước...
                </div>
                <div class="card-face card-back" id="cardBack">
                    Mặt sau...
                </div>
            </div>
        </div>

        <div class="review-navigation" id="reviewNavigation">
            <div class="d-grid gap-3 grid-cols-2 d-flex">
                <button class="btn btn-danger w-100" onclick="handleReview(false)">
                    <i class="bi bi-x-lg"></i> Không nhớ
                </button>
                <button class="btn btn-success w-100" onclick="handleReview(true)">
                    <i class="bi bi-check-lg"></i> Nhớ
                </button>
            </div>
        </div>

        <div class="text-center mt-3" id="flipInstruction">
            <p class="text-muted">(Nhấn vào thẻ hoặc bấm phím Space để lật)</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let setId = null;
    let allCards = [];
    let currentCardIndex = 0;
    let userSubjectId = 0; // Thêm biến này để lưu link quay lại

    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }
        $.ajaxSetup({
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });

        const pathParts = window.location.pathname.split('/');
        setId = pathParts[pathParts.length - 1];

        loadFlashcardData(setId);

        $("#cardContainer").on("click", flipCard);

        $(document).on('keydown', function(e) {
            if ($("#mainContent").is(":visible") && !$("#sessionComplete").is(":visible")) {
                 if (e.which === 32) { // Phím Space
                    e.preventDefault();
                    flipCard();
                } else if (e.which === 37) { // Mũi tên trái
                    e.preventDefault();
                    if ($("#reviewNavigation").is(":visible")) { handleReview(false); }
                } else if (e.which === 39) { // Mũi tên phải
                    e.preventDefault();
                     if ($("#reviewNavigation").is(":visible")) { handleReview(true); }
                }
            }
        });
    });

    function loadFlashcardData(setId) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/flashcards/${setId}`,
            success: function(data) {
                // data là FlashcardSetDTO
                allCards = data.flashcards || [];
                if (allCards.length === 0) {
                    $("#pageLoading").html('<h4 class="text-danger">Bộ thẻ này không có thẻ nào!</h4>');
                    return;
                }

                $("#setTitle").text(data.title);
                // Lấy userSubjectId từ API (nếu bạn đã thêm nó vào DTO)
                // Hoặc chúng ta quay lại dashboard
                $("#backButton").attr("href", "/dashboard");

                currentCardIndex = 0;
                showCard(currentCardIndex);

                $("#pageLoading").hide();
                $("#mainContent").show();
            },
            error: function(xhr) {
                alert("Lỗi tải Flashcard: " + (xhr.responseJSON?.message || xhr.responseText));
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    function showCard(index) {
        if (index >= allCards.length) {
            $("#mainContent").hide();
            // Cập nhật link quay lại trang môn học
            $("#sessionComplete").find("p.lead").text(`Bạn đã hoàn thành ${allCards.length} thẻ.`);
            $("#sessionComplete").find("a").attr("href", "/my-subject/" + userSubjectId);
            $("#sessionComplete").show();
            return;
        }
        const card = allCards[index];
        $("#reviewNavigation").hide();
        $("#flipInstruction").show();
        $("#flashcard").removeClass("is-flipped");
        setTimeout(() => {
            $("#cardFront").text(card.frontText);
            $("#cardBack").text(card.backText);
        }, 300);
        $("#cardCounter").text(`${index + 1} / ${allCards.length}`);

        // 4. Cập nhật nút điều hướng
        $("#prevCard").prop('disabled', index === 0);
        $("#nextCard").prop('disabled', index === allCards.length - 1);
    }

    /**
     */
    function flipCard() {
        $("#flashcard").toggleClass("is-flipped");
        const $card = $("#flashcard");
        $card.toggleClass("is-flipped"); // Lật qua lật lại

        // Nếu vừa lật ra MẶT SAU (hiện nút)
        if ($card.hasClass("is-flipped")) {
            $("#reviewNavigation").show();
            $("#flipInstruction").hide();
        }
        // Nếu vừa lật về MẶT TRƯỚC (ẩn nút)
        else {
            $("#reviewNavigation").hide();
            $("#flipInstruction").show();
        }
    }

    function handleReview(wasRemembered) {
        const currentCard = allCards[currentCardIndex];
        const cardId = currentCard.flashcardId;

        // KIỂM TRA QUAN TRỌNG: Đảm bảo DTO của bạn trả về flashcardId
        if (!cardId) {
             alert("Lỗi: Không tìm thấy flashcardId trong dữ liệu thẻ. Hãy đảm bảo FlashcardSetDTO trả về 'flashcardId' cho mỗi thẻ.");
             return;
        }

        $("#reviewNavigation").find("button").prop("disabled", true);

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/flashcards/review",
            contentType: "application/json",
            data: JSON.stringify({
                flashcardId: cardId,
                wasRemembered: wasRemembered
            }),
            success: function() {
                currentCardIndex++;
                showCard(currentCardIndex);
            },
            error: function(xhr) {
                alert("Lỗi khi lưu tiến độ: " + (xhr.responseJSON?.message || xhr.responseText));
                if (xhr.status === 401 || xhr.status === 403) logout();
            },
            complete: function() {
                $("#reviewNavigation").find("button").prop("disabled", false);
            }
        });
    }

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }
</script>
</body>
</html>