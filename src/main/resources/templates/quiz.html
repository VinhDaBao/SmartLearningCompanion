<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m Quiz - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f4f7f6;
        }
        .quiz-container {
            max-width: 800px;
            margin-top: 30px;
        }
        /* T√πy ch·ªânh Carousel */
        .carousel-control-prev, .carousel-control-next {
            width: 5%;
        }
        .carousel-control-prev-icon, .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
        }

        /* T√πy ch·ªânh c√°c l·ª±a ch·ªçn (Options) */
        .quiz-option {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            text-align: left;
            border: 2px solid #eee;
            transition: all 0.2s ease-in-out;
        }
        .quiz-option:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        /* CSS cho c√°c c√¢u tr·∫£ l·ªùi ƒë√£ ƒë∆∞·ª£c ch·ªçn */
        .quiz-option.selected {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0a58ca !important;
        }

        /* CSS cho k·∫øt qu·∫£ (sau khi n·ªôp) */
        .quiz-option.correct {
            background-color: #198754 !important;
            color: white !important;
            border-color: #146c43 !important;
        }
        .quiz-option.incorrect {
            background-color: #dc3545 !important;
            color: white !important;
            border-color: #b02a37 !important;
        }

        #resultsScreen {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .text-result-bad { color: #dc3545; } /* ƒê·ªè */
        .text-result-medium { color: #ffc107; } /* V√†ng */
        .text-result-good { color: #198754; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-success shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>
        <h4 class="navbar-text text-white mb-0" id="quizTitle">ƒêang t·∫£i Quiz...</h4>
        <a class="btn btn-outline-light" id="backButton" href="#">
            <i class="bi bi-arrow-left-circle"></i> Quay l·∫°i
        </a>
    </div>
</nav>

<div class="container quiz-container">

    <div id="quizScreen">
        <div class="progress mb-3" style="height: 10px;">
            <div id="quizProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="quizCarousel" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
            <div class="carousel-inner" id="carouselInner">
            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#quizCarousel" data-bs-slide="prev" style="display: none;">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#quizCarousel" data-bs-slide="next" style="display: none;">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>

        <button class="btn btn-success btn-lg w-100 mt-3" id="submitQuizButton" style="display: none;">
            <i class="bi bi-check2-circle"></i> N·ªôp b√†i v√† Xem k·∫øt qu·∫£
        </button>
    </div>

    <div id="resultsScreen" class="card shadow-sm border-0">
        <div class="card-body text-center p-5">
            <h1 class="display-3">Ho√†n th√†nh!</h1>
            <h2 class="mb-4">K·∫øt qu·∫£ c·ªßa b·∫°n: <span id="quizScore" class="text-success"></span></h2>
            <div id="scoreChartContainer" style="max-width: 200px; margin: 0 auto 20px;">
                <canvas id="scoreChart"></canvas> </div>
            <a class="btn btn-primary" href="/dashboard">V·ªÅ Dashboard</a>
            <button class="btn btn-outline-secondary" onclick="window.location.reload()">L√†m l·∫°i</button>
        </div>
        <div class="card-footer" id="explanationsContainer">
            <h3><i class="bi bi-lightbulb-fill text-warning"></i> Xem l·∫°i ƒë√°p √°n</h3>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let quizId = null;
    let allQuestions = []; // L∆∞u tr·ªØ t·∫•t c·∫£ c√¢u h·ªèi
    let userAnswers = {}; // L∆∞u tr·ªØ { questionId: "A" }
    let scoreChartInstance = null;
    let carousel = null;

    $(document).ready(function() {
        // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }
        $.ajaxSetup({
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });

        // 2. L·∫•y quizId t·ª´ URL
        const pathParts = window.location.pathname.split('/');
        quizId = pathParts[pathParts.length - 1];

        carousel = new bootstrap.Carousel(document.getElementById('quizCarousel'));

        // 3. T·∫£i d·ªØ li·ªáu Quiz
        loadQuizData(quizId);

        // 4. G·∫Øn s·ª± ki·ªán
        $("#submitQuizButton").on("click", handleSubmitQuiz);
    });

    function loadQuizData(quizId) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/quizzes/${quizId}`,
            success: function(data) {
                // data l√† QuizDetailDTO
                allQuestions = data.questions || [];
                if (allQuestions.length === 0) {
                    alert("Quiz n√†y kh√¥ng c√≥ c√¢u h·ªèi!");
                    return;
                }

                $("#quizTitle").text(data.title);
                // ƒê·∫∑t link "Quay l·∫°i"
                $("#backButton").attr("href", `/my-subject/${data.userSubjectId}`);

                renderQuestions(allQuestions);
                updateProgress(0); // B·∫Øt ƒë·∫ßu
            },
            error: function(xhr) {
                alert("L·ªói t·∫£i Quiz: " + xhr.responseText);
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    /**
     * Render c√°c c√¢u h·ªèi v√†o Carousel
     */
    function renderQuestions(questions) {
        const carouselInner = $("#carouselInner");
        carouselInner.empty();

        questions.forEach((q, index) => {
            const isActive = (index === 0) ? "active" : "";
            let optionsHtml = '';

            // Tr·ªôn c√°c l·ª±a ch·ªçn (n·∫øu mu·ªën)
            const options = q.options; // { "A": "...", "B": "..." }
            for (const key in options) {
                optionsHtml += `
                    <button class="btn btn-outline-primary quiz-option" data-question-id="${q.questionId}" data-option-key="${key}">
                        <strong>${key}.</strong> ${options[key]}
                    </button>
                `;
            }

            const questionItem = `
                <div class="carousel-item ${isActive}">
                    <div class="card shadow border-0">
                        <div class="card-body p-4 p-md-5">
                            <h5 class="card-title mb-4">C√¢u ${index + 1} / ${questions.length}</h5>
                            <p class="lead" style="min-height: 50px;">${q.questionText}</p>
                            <hr>
                            <div class="quiz-options-list">
                                ${optionsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            carouselInner.append(questionItem);
        });

        // G·∫Øn s·ª± ki·ªán Click cho T·∫§T C·∫¢ c√°c n√∫t l·ª±a ch·ªçn
        $(".quiz-option").on("click", handleOptionSelect);
    }

    /**
     * Khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt ƒë√°p √°n
     */
    function handleOptionSelect(event) {
        const selectedButton = $(this);
        const questionId = selectedButton.data("question-id");
        const optionKey = selectedButton.data("option-key");

        // 1. L∆∞u c√¢u tr·∫£ l·ªùi
        userAnswers[questionId] = optionKey;

        // 2. C·∫≠p nh·∫≠t UI (L√†m "ƒë·∫πp")
        // X√≥a class 'selected' c·ªßa c√°c n√∫t C√ôNG c√¢u h·ªèi
        selectedButton.closest(".quiz-options-list").find(".quiz-option").removeClass("selected");
        // Th√™m class 'selected' cho n√∫t v·ª´a b·∫•m
        selectedButton.addClass("selected");

        // 3. C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô
        const answeredCount = Object.keys(userAnswers).length;
        updateProgress(answeredCount);

        // 4. T·ª± ƒë·ªông tr∆∞·ª£t (slide) sang c√¢u ti·∫øp theo
        const currentItemIndex = $(".carousel-item.active").index();
        if (currentItemIndex < allQuestions.length - 1) {
            setTimeout(() => {
                carousel.next(); // T·ª± ƒë·ªông tr∆∞·ª£t
            }, 300); // Ch·ªù 0.3s
        }
    }

    /**
     * C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô
     */
    function updateProgress(answeredCount) {
        const total = allQuestions.length;
        const percentage = (answeredCount / total) * 100;
        $("#quizProgress").css("width", percentage + "%");

        // N·∫øu ƒë√£ tr·∫£ l·ªùi h·∫øt, hi·ªán n√∫t N·ªôp b√†i
        if (answeredCount === total) {
            $("#submitQuizButton").show();
        }
    }

    /**
     * Khi b·∫•m n√∫t N·ªôp b√†i
     */
    function handleSubmitQuiz() {
            let score = 0;
            const explanationsHtml = [];

            // 1. Ch·∫•m ƒëi·ªÉm
            allQuestions.forEach((q, index) => {
                const userAnsKey = userAnswers[q.questionId] || null; // L·∫•y key (v√≠ d·ª•: 'A')
                const correctAnsKey = q.correctAnswer;
                const options = q.options; // { "A": "Text A", "B": "Text B" }

                // M·ªöI: L·∫•y n·ªôi dung text c·ªßa c√¢u tr·∫£ l·ªùi
                const userAnsText = userAnsKey ? options[userAnsKey] : "<i>(B·ªè qua)</i>";
                const correctAnsText = options[correctAnsKey];

                let explanation = `
                    <div class="p-3 mb-2 border rounded">
                        <p class="mb-1"><strong>C√¢u ${index + 1}:</strong> ${q.questionText}</p>
                `;

                if (userAnsKey === correctAnsKey) {
                    score++;
                    // S·ª¨A: Hi·ªÉn th·ªã c·∫£ Key v√† Text
                    explanation += `<p class="mb-1">B·∫°n ƒë√£ ch·ªçn: <strong class="text-success">${userAnsKey}. ${userAnsText} (ƒê√∫ng)</strong></p>`;
                } else if (userAnsKey === null) {
                    explanation += `<p class="mb-1">B·∫°n ƒë√£ ch·ªçn: <strong class="text-muted">${userAnsText}</strong></p>`;
                    // S·ª¨A: Hi·ªÉn th·ªã c·∫£ Key v√† Text
                    explanation += `<p class="mb-1">ƒê√°p √°n ƒë√∫ng: <strong class="text-success">${correctAnsKey}. ${correctAnsText}</strong></p>`;
                } else { // Tr·∫£ l·ªùi sai
                    // S·ª¨A: Hi·ªÉn th·ªã c·∫£ Key v√† Text
                    explanation += `<p class="mb-1">B·∫°n ƒë√£ ch·ªçn: <strong class="text-danger">${userAnsKey}. ${userAnsText} (Sai)</strong></p>`;
                    explanation += `<p class="mb-1">ƒê√°p √°n ƒë√∫ng: <strong class="text-success">${correctAnsKey}. ${correctAnsText}</strong></p>`;
                }
                explanation += `<p class="text-muted mb-0"><em>Gi·∫£i th√≠ch: ${q.explanation}</em></p></div>`;
                explanationsHtml.push(explanation);
            });

            const total = allQuestions.length;
            const percentage = Math.round((score / total) * 100);

            // 2. ·∫®n Quiz, Hi·ªán K·∫øt qu·∫£
            $("#quizScreen").hide();
            $("#resultsScreen").show();

            // 3. (S·ª¨A) Hi·ªÉn th·ªã ƒëi·ªÉm V√Ä th√¥ng ƒëi·ªáp ƒë·ªông
            const scoreText = $("#quizScore");
            const resultTitle = $("#resultTitle");

            scoreText.text(`${score} / ${total} (${percentage}%)`);
            scoreText.removeClass("text-result-bad text-result-medium text-result-good"); // X√≥a m√†u c≈©

            if (percentage < 50) {
                resultTitle.text("C·∫ßn c·ªë g·∫Øng h∆°n! üò¢");
                scoreText.addClass("text-result-bad"); // Th√™m class m√†u ƒë·ªè
            } else if (percentage < 80) {
                resultTitle.text("L√†m t·ªët l·∫Øm! ü§î");
                scoreText.addClass("text-result-medium"); // Th√™m class m√†u v√†ng
            } else {
                resultTitle.text("Tuy·ªát v·ªùi! üéâ");
                scoreText.addClass("text-result-good"); // Th√™m class m√†u xanh
            }

            // 4. Hi·ªÉn th·ªã gi·∫£i th√≠ch
            $("#explanationsContainer").append(explanationsHtml.join(""));

            // 5. V·∫Ω bi·ªÉu ƒë·ªì
            renderScoreChart(score, total - score);
        }

    function renderScoreChart(correct, incorrect) {
        if(scoreChartInstance) scoreChartInstance.destroy();
        const ctx = document.getElementById('scoreChart').getContext('d');
        scoreChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ƒê√∫ng', 'Sai'],
                datasets: [{
                    data: [correct, incorrect],
                    backgroundColor: ['#198754', '#dc3545']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

</script>
</body>
</html>