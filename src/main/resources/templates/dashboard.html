<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        .loading-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: text-bottom;
            border: .2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: .75s linear infinite spinner-border;
        }

        /* Th√™m CSS cho Toast */
        .toast-container {
            z-index: 1100;
        }

        /* üí° Card cho "M√¥n h·ªçc c·ªßa t√¥i" */
        .subject-card {
            background: #ffffff;
            border-radius: 1rem;
            border: 1px solid #e3e6f0;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.25rem;
            transition: all .15s ease-in-out;
        }

        .subject-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #0d6efd33;
        }

        .subject-info h5 {
            margin-bottom: .25rem;
        }

        .subject-info .progress-text {
            font-size: 0.9rem;
        }

        /* Nh√≥m n√∫t to, nh√¨n ‚Äúƒë√£‚Äù h∆°n */
        .subject-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .subject-actions .btn {
            min-width: 130px;
            font-weight: 500;
            border-radius: 999px; /* pill */
        }

        @media (max-width: 768px) {
            .subject-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .subject-actions {
                width: 100%;
            }

            .subject-actions .btn {
                flex: 1 1 calc(50% - 0.5rem);
            }
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain-fill"></i> Smart Learning</a>

        <button class="btn btn-success me-auto" data-bs-toggle="modal" data-bs-target="#logSessionModal">
            <i class="bi bi-clock-history"></i> Log th·ªùi gian h·ªçc
        </button>

        <div class="d-flex align-items-center">
            <span class="navbar-text me-3" id="welcomeMessage"></span>
            <a class="btn btn-outline-light me-2" href="/profile" title="H·ªì s∆° c·ªßa t√¥i">
                <i class="bi bi-person-circle"></i>
            </a>
            <button class="btn btn-outline-light" id="logoutButton" title="ƒêƒÉng xu·∫•t">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h1 class="h3 mb-4">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="userNameHeader" class="text-primary"></span>!</h1>

    <div class="row mb-4">
        <div class="col-lg-7 mb-3 mb-lg-0">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart-line-fill text-primary"></i> Th·ªùi gian h·ªçc (ph√∫t)</h5>
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-pie-chart-fill text-success"></i> Th·ªëng k√™ ho·∫°t ƒë·ªông</h5>
                    <canvas id="activityChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-journal-bookmark-fill text-info"></i> M√¥n h·ªçc c·ªßa t√¥i</h2>
    <div class="row" id="mySubjectsList">
        <div class="col-12 text-center" id="mySubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>ƒêang t·∫£i c√°c m√¥n h·ªçc c·ªßa b·∫°n...</p>
        </div>
        <div class="col-12" id="noMySubjects" style="display: none;">
            <div class="alert alert-info">B·∫°n ch∆∞a ƒëƒÉng k√Ω m√¥n h·ªçc n√†o. H√£y kh√°m ph√° c√°c m√¥n h·ªçc b√™n d∆∞·ªõi!</div>
        </div>
    </div>

    <hr class="my-4">
    <h2><i class="bi bi-search text-warning"></i> Kh√°m ph√° m√¥n h·ªçc</h2>
    <div class="row" id="exploreSubjectsList">
        <div class="col-12 text-center" id="exploreSubjectsLoading">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p>ƒêang t·∫£i danh s√°ch m√¥n h·ªçc...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> T·∫°o L·ªô tr√¨nh h·ªçc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planUserSubjectId">

                    <div class="mb-3">
                        <label for="customPrompt" class="form-label">Y√™u c·∫ßu t√πy ch·ªânh:</label>
                        <textarea class="form-control" id="customPrompt" rows="3"
                                  placeholder="V√≠ d·ª•: T·∫≠p trung v√†o th·ª±c h√†nh, ho·∫∑c t·∫°o l·ªô tr√¨nh trong 3 tu·∫ßn..."></textarea>
                    </div>

                    <!-- üåü M·ªöI: Upload b√†i gi·∫£ng cho Plan -->
                    <div class="mb-3">
                        <label for="planLectureFile" class="form-label">
                            T·∫£i file b√†i gi·∫£ng / slide (tu·ª≥ ch·ªçn)
                        </label>
                        <input class="form-control" type="file" id="planLectureFile"
                               accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
                        <div class="form-text">
                            AI s·∫Ω ƒë·ªçc n·ªôi dung file n√†y ƒë·ªÉ ƒë·ªÅ xu·∫•t l·ªô tr√¨nh s√°t v·ªõi b√†i gi·∫£ng c·ªßa b·∫°n h∆°n.
                        </div>
                    </div>

                    <div id="planResult" class="mt-3 p-3 bg-light border rounded"
                         style="display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="submitPlanButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quizModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-patch-question-fill"></i> T·∫°o Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quizForm">
                    <input type="hidden" id="quizUserSubjectId">

                    <div class="mb-3">
                        <label for="quizTopic" class="form-label">Ch·ªß ƒë·ªÅ Quiz (T√πy ch·ªçn):</label>
                        <input type="text" class="form-control" id="quizTopic"
                               placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1: Gi·ªõi thi·ªáu, ho·∫∑c ƒë·ªÉ tr·ªëng">
                    </div>

                    <div class="mb-3">
                        <label for="quizNumQuestions" class="form-label">S·ªë l∆∞·ª£ng c√¢u h·ªèi:</label>
                        <select class="form-select" id="quizNumQuestions">
                            <option value="5">5 c√¢u</option>
                            <option value="10" selected>10 c√¢u</option>
                            <option value="15">15 c√¢u</option>
                            <option value="20">20 c√¢u</option>
                            <option value="25">25 c√¢u</option>
                            <option value="30">30 c√¢u</option>
                            <option value="35">35 c√¢u</option>
                            <option value="40">40 c√¢u</option>
                            <option value="45">45 c√¢u</option>
                            <option value="50">50 c√¢u</option>
                        </select>
                    </div>

                    <!-- üåü M·ªöI: Upload b√†i gi·∫£ng cho Quiz -->
                    <div class="mb-3">
                        <label for="quizLectureFile" class="form-label">
                            T·∫£i file b√†i gi·∫£ng ƒë·ªÉ t·∫°o c√¢u h·ªèi (tu·ª≥ ch·ªçn)
                        </label>
                        <input class="form-control" type="file" id="quizLectureFile"
                               accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
                        <div class="form-text">
                            N√™n ch·ªçn ƒë√∫ng slide / ch∆∞∆°ng b·∫°n mu·ªën t·∫°o Quiz ƒë·ªÉ c√¢u h·ªèi s√°t n·ªôi dung nh·∫•t.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" id="submitQuizButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="flashcardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-card-checklist"></i> T·∫°o Flashcard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="flashcardForm">
                    <input type="hidden" id="flashcardUserSubjectId">
                    <div class="mb-3">
                        <label for="flashcardTitle" class="form-label">Ti√™u ƒë·ªÅ b·ªô Flashcard:</label>
                        <input type="text" class="form-control" id="flashcardTitle" required placeholder="V√≠ d·ª•: C√°c thu·∫≠t ng·ªØ Spring Boot">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardTopic" class="form-label">Ch·ªß ƒë·ªÅ (T√πy ch·ªçn):</label>
                        <input type="text" class="form-control" id="flashcardTopic" placeholder="V√≠ d·ª•: Annotations, ho·∫∑c ƒë·ªÉ tr·ªëng">
                    </div>
                    <div class="mb-3">
                        <label for="flashcardNumCards" class="form-label">S·ªë l∆∞·ª£ng th·∫ª:</label>
                        <select class="form-select" id="flashcardNumCards">
                            <option value="10" selected>10 th·∫ª</option>
                            <option value="20">20 th·∫ª</option>
                            <option value="30">30 th·∫ª</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-warning" id="submitFlashcardButton">
                    <span class="loading-spinner" role="status"></span> <i class="bi bi-magic"></i> T·∫°o Flashcard
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="logSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Ghi l·∫°i th·ªùi gian h·ªçc
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logSessionForm">
                    <div class="mb-3">
                        <label for="logSubject" class="form-label">M√¥n h·ªçc</label>
                        <select class="form-select" id="logSubject" required>
                            <option value="" disabled selected>-- Ch·ªçn m√¥n h·ªçc --</option>
                            <!-- JS s·∫Ω t·ª± fill c√°c option ·ªü loadSubjectsAndEnrollments(...) -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="logDuration" class="form-label">
                            Th·ªùi gian h·ªçc (ph√∫t)
                        </label>
                        <input type="number" min="1" class="form-control"
                               id="logDuration" placeholder="V√≠ d·ª•: 30" required>
                    </div>

                    <div class="mb-3">
                        <label for="logDetails" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                        <textarea class="form-control" id="logDetails" rows="3"
                                  placeholder="V√≠ d·ª•: √în l·∫°i Ch∆∞∆°ng 1, l√†m b√†i t·∫≠p √¥n t·∫≠p..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">ƒê√≥ng</button>

                <button type="button"
                        class="btn btn-success"
                        id="submitLogButton">
                    <span class="loading-spinner" role="status"></span>
                    <i class="bi bi-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- (Bi·∫øn to√†n c·ª•c) ---
    let currentUserId = null;
    let timeChartInstance = null;
    let activityChartInstance = null;
    let planModal = null;
    let quizModal = null;
    let flashcardModal = null; // M·ªöI
    let logSessionModal = null;
    let toastCount = 0; // ƒê·∫øm toast

    // --- (H√†m ch·∫°y ƒë·∫ßu ti√™n) ---
    $(document).ready(function() {
        // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        const token = localStorage.getItem("jwtToken");
        const username = localStorage.getItem("username");
        if (!token) { window.location.href = "/login"; return; }

        // 2. G·∫Øn Token v√†o t·∫•t c·∫£ request
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        // 3. Setup UI
        $("#welcomeMessage").text("Ch√†o, " + username);
        $("#userNameHeader").text(username);
        $("#logoutButton").on("click", logout);

        // 4. Kh·ªüi t·∫°o Modals
        planModal = new bootstrap.Modal(document.getElementById('planModal'));
        quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
        flashcardModal = new bootstrap.Modal(document.getElementById('flashcardModal'));
        logSessionModal = new bootstrap.Modal(document.getElementById('logSessionModal'));
        // 5. B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu
        loadUserData(username);

        // 6. G·∫Øn s·ª± ki·ªán cho c√°c n√∫t "T·∫°o" (submit)
        $("#submitPlanButton").on("click", handleGeneratePlan);
        $("#submitQuizButton").on("click", handleGenerateQuiz);
        $("#submitFlashcardButton").on("click", handleGenerateFlashcard);
        $("#submitLogButton").on("click", handleLogSession);
    });

    // --- (H√†m ƒêƒÉng xu·∫•t) ---
    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    // --- (H√†m T·∫£i D·ªØ li·ªáu) ---
    function loadUserData(username) {
        $.ajax({
            type: "GET", url: `http://localhost:8080/api/users/${username}`,
            success: function(userDTO) {
                currentUserId = userDTO.userId;
                // T·∫£i song song 2 lu·ªìng
                loadDashboardData(currentUserId);
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    function loadDashboardData(userId) {
        $.ajax({
            type: "GET", url: `http://localhost:8080/api/dashboard/${userId}`,
            success: function(data) {
                renderTimeChart(data.timeLabels || [], data.timeData || []);
                renderActivityChart(data.activityCounts || {});
            },
            error: function(xhr) { console.error("L·ªói t·∫£i dashboard:", xhr.responseText); }
        });
    }

    // --- (H√†m T·∫£i M√¥n h·ªçc - ƒê√É N√ÇNG C·∫§P) ---
    async function loadSubjectsAndEnrollments(userId) {
        // Hi·ªÉn th·ªã spinner
        $("#mySubjectsLoading").show();
        $("#exploreSubjectsLoading").show();
        $("#noMySubjects").hide();

        const mySubjectsListDiv = $("#mySubjectsList");
        const exploreSubjectsListDiv = $("#exploreSubjectsList");
        const logSubjectSelect = $("#logSubject");

        mySubjectsListDiv.empty();
        exploreSubjectsListDiv.empty();
        logSubjectSelect.empty().append('<option value="" disabled selected>-- Ch·ªçn m√¥n h·ªçc --</option>');

        try {
            // 1. L·∫•y M√îN ƒê√É ƒêƒÇNG K√ù
            const enrolledSubjects = await $.ajax({ url: `http://localhost:8080/api/users/${userId}/subjects` });
            const enrolledMap = new Map();

            if (enrolledSubjects.length === 0) {
                $("#noMySubjects").show();
            } else {
                enrolledSubjects.forEach(us => {
                    enrolledMap.set(us.subject.subjectId, us.id); // Map: (subjectId -> userSubjectId)

                    // üîπ Card "M√¥n h·ªçc c·ªßa t√¥i" d·∫°ng h√¨nh ch·ªØ nh·∫≠t full width, n√∫t to & ƒë·∫πp
                    const cardHtml = `
                        <div class="col-12 mb-3">
                            <div class="subject-card">
                                <div class="subject-info">
                                    <h5 class="mb-1">${us.subject.subjectName}</h5>
                                    <p class="text-muted progress-text mb-0">
                                        ƒê√£ ƒëƒÉng k√Ω ¬∑ Ti·∫øn ƒë·ªô: <strong>${us.progressPercentage}%</strong>
                                    </p>
                                </div>
                                <div class="subject-actions">
                                    <button class="btn btn-outline-info"
                                            onclick="viewSubjectContent(${us.id})">
                                        <i class="bi bi-book me-1"></i> H·ªçc
                                    </button>
                                    <button class="btn btn-outline-primary"
                                            onclick="openPlanModal(${us.id})">
                                        <i class="bi bi-calendar-check me-1"></i> Plan
                                    </button>
                                    <button class="btn btn-outline-success"
                                            onclick="openQuizModal(${us.id})">
                                        <i class="bi bi-patch-question me-1"></i> Quiz
                                    </button>
                                    <button class="btn btn-outline-warning"
                                            onclick="openFlashcardModal(${us.id})">
                                        <i class="bi bi-card-checklist me-1"></i> Flashcard
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    mySubjectsListDiv.append(cardHtml);
                    logSubjectSelect.append(
                        `<option value="${us.id}">${us.subject.subjectName}</option>`
                    );
                });
            }

            // 2. L·∫•y T·∫§T C·∫¢ m√¥n h·ªçc
            const allSubjects = await $.ajax({ url: "http://localhost:8080/api/subjects" });

            allSubjects.forEach(subject => {
                // N·∫øu m√¥n n√†y CH∆ØA c√≥ trong map ƒë√£ ƒëƒÉng k√Ω -> hi·ªÉn th·ªã ·ªü khu "Kh√°m ph√°"
                if (!enrolledMap.has(subject.subjectId)) {
                    const cardHtml = `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${subject.subjectName}</h5>
                                    <p class="card-text text-muted">${subject.description.substring(0, 100)}...</p>
                                    <div class="mt-auto">
                                        <button class="btn btn-outline-primary w-100" id="enrollBtn-${subject.subjectId}" onclick="enroll(${subject.subjectId})">
                                            <span class="loading-spinner" id="enrollSpinner-${subject.subjectId}"></span>
                                            <i class="bi bi-plus-circle"></i> ƒêƒÉng k√Ω h·ªçc
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    exploreSubjectsListDiv.append(cardHtml);
                }
            });

        } catch (xhr) {
            console.error("L·ªói khi t·∫£i m√¥n h·ªçc:", xhr.responseText);
            mySubjectsListDiv.html('<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√¥n h·ªçc.</div>');
        } finally {
            // ·∫®n t·∫•t c·∫£ spinner
            $("#mySubjectsLoading").hide();
            $("#exploreSubjectsLoading").hide();
        }
    }

    // --- (H√†m ƒêƒÉng k√Ω) ---
    function enroll(subjectId) {
        const btn = $(`#enrollBtn-${subjectId}`);
        const spinner = $(`#enrollSpinner-${subjectId}`);
        btn.prop('disabled', true);
        spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/enroll",
            contentType: "application/json",
            data: JSON.stringify({ userId: currentUserId, subjectId: subjectId }),
            success: function(userSubjectDTO) {
                showToast("ƒêƒÉng k√Ω m√¥n h·ªçc th√†nh c√¥ng!");
                // T·∫£i l·∫°i c·∫£ 2 danh s√°ch
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                showToast("L·ªói: " + xhr.responseText, "error");
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    // --- (H√†m M·ªü Modals) ---
    function openPlanModal(userSubjectId) {
        $("#planUserSubjectId").val(userSubjectId);
        $("#planForm")[0].reset();
        $("#planResult").hide().empty();
        $("#submitPlanButton").prop('disabled', false).find(".loading-spinner").hide();
        planModal.show();
    }

    function openQuizModal(userSubjectId) {
        $("#quizUserSubjectId").val(userSubjectId);
        $("#quizForm")[0].reset();
        $("#quizResult").hide().empty();
        $("#submitQuizButton").prop('disabled', false).find(".loading-spinner").hide();
        quizModal.show();
    }

    // M·ªöI
    function openFlashcardModal(userSubjectId) {
        $("#flashcardUserSubjectId").val(userSubjectId);
        $("#flashcardForm")[0].reset();
        $("#submitFlashcardButton").prop('disabled', false).find(".loading-spinner").hide();
        flashcardModal.show();
    }

    function viewSubjectContent(userSubjectId) {
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang "Chi ti·∫øt M√¥n h·ªçc"
            window.location.href = "/my-subject/" + userSubjectId;
        }

    // --- (H√†m G·ªçi API T·∫°o AI) ---
    function handleGeneratePlan() {
        const btn = $("#submitPlanButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true);
        spinner.show();
        $("#planResult").hide().empty();

        // üåü T·∫°o object meta ƒë·ªÉ g·ª≠i k√®m
        const requestObj = {
            userSubjectId: $("#planUserSubjectId").val(),
            customPrompt: $("#customPrompt").val()
        };

        const formData = new FormData();
        // G·ª≠i JSON meta d∆∞·ªõi d·∫°ng Blob
        formData.append(
            "request",
            new Blob([JSON.stringify(requestObj)], { type: "application/json" })
        );

        // N·∫øu c√≥ ch·ªçn file th√¨ th√™m v√†o
        const fileInput = $("#planLectureFile")[0];
        if (fileInput.files && fileInput.files[0]) {
            formData.append("lectureFile", fileInput.files[0]);
        }

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/study-plans/generate",
            data: formData,
            processData: false,      // Quan tr·ªçng
            contentType: false,      // Quan tr·ªçng
            success: function(planDTO) {
                $("#planResult").text(planDTO.planContent).show();
                showToast("T·∫°o l·ªô tr√¨nh th√†nh c√¥ng!");
                loadDashboardData(currentUserId);
            },
            error: function(xhr) {
                $("#planResult").text("L·ªói: " + xhr.responseText).show();
            },
            complete: function() {
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function handleGenerateQuiz() {
        const btn = $("#submitQuizButton");
        const spinner = btn.find(".loading-spinner");
        btn.prop('disabled', true);
        spinner.show();

        const requestObj = {
            userSubjectId: $("#quizUserSubjectId").val(),
            topic: $("#quizTopic").val() || null,
            numberOfQuestions: $("#quizNumQuestions").val()
        };

        const formData = new FormData();
        formData.append(
            "request",
            new Blob([JSON.stringify(requestObj)], { type: "application/json" })
        );

        const fileInput = $("#quizLectureFile")[0];
        if (fileInput.files && fileInput.files[0]) {
            formData.append("lectureFile", fileInput.files[0]);
        }

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/quizzes/generate",
            data: formData,
            processData: false,
            contentType: false,
            success: function(quizDTO) {
                showToast(`T·∫°o Quiz th√†nh c√¥ng! Chu·∫©n b·ªã l√†m b√†i...`);
                loadDashboardData(currentUserId);

                setTimeout(function() {
                    window.location.href = "/quiz/" + quizDTO.quizId;
                }, 1000);
            },
            error: function(xhr) {
                alert("L·ªói t·∫°o Quiz: " + xhr.responseText);
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    function handleGenerateFlashcard() {
        const btn = $("#submitFlashcardButton");
        const spinner = btn.find(".loading-spinner");
        const title = $("#flashcardTitle").val();
        if (!title) { alert("Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ!"); return; }

        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST", url: "http://localhost:8080/api/flashcards/generate",
            contentType: "application/json",
            data: JSON.stringify({
                userSubjectId: $("#flashcardUserSubjectId").val(),
                title: title,
                topic: $("#flashcardTopic").val() || null,
                numberOfCards: $("#flashcardNumCards").val()
            }),
            success: function(setDTO) {
                // setDTO gi·ªù ch·ª©a "setId"
                showToast(`T·∫°o th√†nh c√¥ng: "${setDTO.title}"! ƒêang t·∫£i...`);

                // T·∫£i l·∫°i chart (trong n·ªÅn)
                loadDashboardData(currentUserId);

                // Ch·ªù 1 gi√¢y r·ªìi chuy·ªÉn h∆∞·ªõng
                setTimeout(function() {
                    window.location.href = "/flashcards/" + setDTO.setId;
                }, 1000);
            },
            error: function(xhr) {
                alert("L·ªói t·∫°o Flashcard: " + xhr.responseText);
                btn.prop('disabled', false); spinner.hide();
            }
        });
    }

    function handleLogSession() {
        const btn = $("#submitLogButton");
        const spinner = btn.find(".loading-spinner");

        const logData = {
            userId: currentUserId,
            userSubjectId: $("#logSubject").val(),
            durationMinutes: $("#logDuration").val(),
            details: $("#logDetails").val() || null
        };

        // Ki·ªÉm tra d·ªØ li·ªáu
        if (!logData.userSubjectId || !logData.durationMinutes || logData.durationMinutes < 1) {
            alert("Vui l√≤ng ch·ªçn m√¥n h·ªçc v√† nh·∫≠p th·ªùi gian h·ª£p l·ªá (l·ªõn h∆°n 0 ph√∫t).");
            return;
        }

        btn.prop('disabled', true); spinner.show();

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/log/session", // API m·ªõi
            contentType: "application/json",
            data: JSON.stringify(logData),
            success: function() {
                showToast("Ghi l·∫°i th·ªùi gian h·ªçc th√†nh c√¥ng!");
                logSessionModal.hide(); // ƒê√≥ng pop-up
                $("#logSessionForm")[0].reset(); // X√≥a form

                // T·∫£i l·∫°i bi·ªÉu ƒë·ªì ƒë·ªÉ th·∫•y th·ªùi gian m·ªõi
                loadDashboardData(currentUserId);
            },
            error: function(xhr) {
                alert("L·ªói khi log: " + xhr.responseText);
            },
            complete: function() {
                btn.prop('disabled', false); spinner.hide();
            }
        });
    }

    // --- (H√†m v·∫Ω bi·ªÉu ƒë·ªì - Gi·ªØ nguy√™n) ---
    function renderTimeChart(labels, data) {
        if(timeChartInstance) timeChartInstance.destroy();
        const ctx = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'S·ªë ph√∫t ƒë√£ h·ªçc', data: data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });
    }
    function renderActivityChart(activityData) {
        if(activityChartInstance) activityChartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        activityChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(activityData), datasets: [{ data: Object.values(activityData), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    // --- M·ªöI: H√†m Hi·ªÉn th·ªã TOAST ---
    function showToast(message, type = "success") {
        const toastId = "toast-" + (toastCount++);
        const bgClass = type === "success" ? "bg-success" : "bg-danger";

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        $("#toastContainer").append(toastHtml);

        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        // X√≥a toast kh·ªèi DOM sau khi n√≥ ·∫©n ƒëi
        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

</script>
</body>
</html>