<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="subjectTitle">M·∫°ng l∆∞·ªõi Tri th·ª©c - Smart Learning</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">

<script type="text/javascript"
	src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* CSS Chung */
.list-group-item .badge {
	font-size: 0.9em;
}

.markdown-body {
	background-color: transparent;
}

/* --- STYLE CHO M·∫†NG L∆Ø·ªöI TRI TH·ª®C --- */
#knowledge-graph {
	width: 100%;
	height: 650px;
	border: 1px solid #dbe6f0;
	border-radius: 8px;
	background-color: #ffffff;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
	margin-top: 15px;
}

/* FIX: TƒÉng chi·ªÅu cao c·ªßa Accordion v√† th√™m thanh cu·ªôn */
#plansAccordion .accordion-body {
	max-height: 500px;
	overflow-y: auto;
}

/* Style cho Modal Recommendation (ƒê√£ gi·ªØ nguy√™n) */
.adaptive-content .header {
	font-size: 1.1em;
	font-weight: bold;
	color: #0056b3;
	margin-bottom: 10px;
}

.adaptive-content .ai-message {
	font-size: 1em;
	color: #333;
	line-height: 1.5;
	margin-bottom: 15px;
	padding: 12px;
	background: #f0f4f9;
	border-radius: 8px;
	border: 1px dashed #0056b3;
}

.content-card {
	display: block;
	background: #ffffff;
	border-radius: 8px;
	padding: 15px;
	text-decoration: none;
	color: #222;
	border: 1px solid #ddd;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
	transition: all 0.2s ease-in-out;
}

.content-card:hover {
	transform: translateY(-3px);
	box-shadow: 0 6px 12px rgba(0, 50, 150, 0.15);
	border-color: #0056b3;
}

.content-card .content-type {
	font-size: 0.8em;
	font-weight: bold;
	color: #0056b3;
	text-transform: uppercase;
	margin-bottom: 5px;
}

.content-card .content-title {
	font-size: 1.1em;
	font-weight: bold;
}

.content-card .content-duration {
	font-size: 0.9em;
	color: #777;
	margin-top: 8px;
}

.congrats-message {
	text-align: center;
	font-size: 1.1em;
	color: #006400;
	font-weight: bold;
	padding: 15px;
	background: #f0fff0;
	border: 1px solid #006400;
	border-radius: 8px;
}

.modal-body-scrollable {
	max-height: 80vh;
	overflow-y: auto;
}
</style>
</head>
<body class="bg-light">

	<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
		<div class="container-fluid">
			<a class="navbar-brand" href="/dashboard"><i
				class="bi bi-brain-fill"></i> Smart Learning</a>
			<div class="d-flex">
				<a class="btn btn-outline-light me-3" href="/dashboard"> <i
					class="bi bi-arrow-left-circle"></i> Quay l·∫°i Dashboard
				</a>
				<button class="btn btn-outline-light" id="logoutButton">
					<i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
				</button>
			</div>
		</div>
	</nav>

	<div class="container mt-4">

		<div id="pageLoading" class="text-center mt-5">
			<div class="spinner-border text-primary"
				style="width: 3rem; height: 3rem;" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
			<h4 class="mt-3">ƒêang t·∫£i n·ªôi dung m√¥n h·ªçc...</h4>
		</div>

		<div id="mainContent" style="display: none;">

			<div class="row align-items-center mb-4">
				<div class="col-md-8">
					<h1 id="subjectName">T√™n m√¥n h·ªçc...</h1>
					<p class="lead text-muted" id="subjectDescription">M√¥ t·∫£ m√¥n
						h·ªçc...</p>
				</div>
				<div class="col-md-4">
					<div class="progress" role="progressbar" style="height: 25px;">
						<div id="subjectProgress"
							class="progress-bar progress-bar-striped progress-bar-animated"
							style="width: 0%">0%</div>
					</div>
					<small class="text-muted mt-1">ƒêi·ªÉm g·∫ßn nh·∫•t: <strong
						id="currentScore">N/A</strong></small>
				</div>
			</div>

			<div class="row">
				<div class="col-lg-6 mb-4">
					<div class="card shadow-lg border-0 h-100">
						<div class="card-body">
							<h4 class="card-title mb-3">
								<i class="bi bi-diagram-3-fill text-info"></i> M·∫°ng l∆∞·ªõi Tri
								th·ª©c C√° nh√¢n
							</h4>
							<p class="text-muted small">
								M√†u s·∫Øc th·ªÉ hi·ªán m·ª©c ƒë·ªô th√¥ng th·∫°o c·ªßa b·∫°n: <span
									class="badge bg-success">Th√¥ng th·∫°o (>=80%)</span> | <span
									class="badge bg-warning">ƒêang h·ªçc (50-79%)</span> | <span
									class="badge bg-danger">Y·∫øu (<50%)</span> | <span
									class="badge bg-secondary">Ch∆∞a h·ªçc</span>. Nh·∫•p v√†o n√∫t ƒë·ªÉ
								nh·∫≠n g·ª£i √Ω!
							</p>

							<div id="knowledge-graph">
								<div
									class="d-flex flex-column justify-content-center align-items-center h-100">
									<div class="spinner-border text-primary" role="status"></div>
									<p class="mt-2 text-muted">ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu
										quiz...</p>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-lg-6 mb-4">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<h4 class="card-title">
								<i class="bi bi-calendar-check text-primary"></i> L·ªô tr√¨nh h·ªçc
								(Plans)
							</h4>
							<div class="accordion" id="plansAccordion"></div>
						</div>
					</div>
				</div>

			</div>

			<hr class="my-4">

			<div class="row">
				<div class="col-lg-6 mb-4">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<h4 class="card-title">
								<i class="bi bi-patch-question-fill text-success"></i> B·ªô Quiz
								(Tr·∫Øc nghi·ªám)
							</h4>
							<div class="list-group list-group-flush" id="quizList"></div>
							<div class="d-flex justify-content-between mt-3"
								id="quizListControls" style="display: none;">
								<button class="btn btn-sm btn-outline-secondary"
									onclick="toggleView('#quizList', 5, '#quizShowMore')">
									<i class="bi bi-chevron-up"></i> ·∫®n b·ªõt
								</button>
								<button id="quizShowMore" class="btn btn-sm btn-primary"
									onclick="toggleView('#quizList', Infinity, '#quizShowMore')">
									<i class="bi bi-chevron-down"></i> Xem t·∫•t c·∫£
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-6 mb-4">
					<div class="card shadow-sm border-0 h-100">
						<div class="card-body">
							<h4 class="card-title">
								<i class="bi bi-card-checklist text-warning"></i> B·ªô Flashcard
							</h4>
							<div class="list-group list-group-flush" id="flashcardList">
							</div>
							<div class="d-flex justify-content-between mt-3"
								id="flashcardListControls" style="display: none;">
								<button class="btn btn-sm btn-outline-secondary"
									onclick="toggleView('#flashcardList', 5, '#flashcardShowMore')">
									<i class="bi bi-chevron-up"></i> ·∫®n b·ªõt
								</button>
								<button id="flashcardShowMore" class="btn btn-sm btn-primary"
									onclick="toggleView('#flashcardList', Infinity, '#flashcardShowMore')">
									<i class="bi bi-chevron-down"></i> Xem t·∫•t c·∫£
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="recommendationModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-light">
					<h5 class="modal-title" id="recommendationTitle">
						<i class="bi bi-lightbulb-fill text-warning"></i> ƒê·ªÅ xu·∫•t H·ªçc t·∫≠p
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="recommendationBody"></div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="planViewerModal" tabindex="-1">
		<div class="modal-dialog modal-xl modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="planViewerTitle">L·ªô tr√¨nh h·ªçc</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body modal-body-scrollable">
					<div class="markdown-body" id="planViewerContent"></div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="quizModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="bi bi-patch-question-fill"></i> T·∫°o Quiz
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="quizForm">
						<input type="hidden" id="quizUserSubjectId">
						<div class="mb-3">
							<label for="quizTopic" class="form-label">Ch·ªß ƒë·ªÅ Quiz
								(T√πy ch·ªçn):</label> <input type="text" class="form-control"
								id="quizTopic"
								placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1: Gi·ªõi thi·ªáu, ho·∫∑c ƒë·ªÉ tr·ªëng">
						</div>
						<div class="mb-3">
							<label for="quizNumQuestions" class="form-label">S·ªë l∆∞·ª£ng
								c√¢u h·ªèi: <strong id="quizCountValue">10</strong> c√¢u
							</label> <input type="range" class="form-range" id="quizNumQuestions"
								min="5" max="50" step="5" value="10"
								oninput="document.getElementById('quizCountValue').innerText = this.value">
						</div>
						<div class="mb-3">
							<label for="quizLectureFile" class="form-label"> T·∫£i file
								b√†i gi·∫£ng ƒë·ªÉ t·∫°o c√¢u h·ªèi (tu·ª≥ ch·ªçn) </label> <input class="form-control"
								type="file" id="quizLectureFile"
								accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
							<div class="form-text">N√™n ch·ªçn ƒë√∫ng slide / ch∆∞∆°ng b·∫°n
								mu·ªën t·∫°o Quiz ƒë·ªÉ c√¢u h·ªèi s√°t n·ªôi dung nh·∫•t.</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">ƒê√≥ng</button>
					<button type="button" class="btn btn-success" id="submitQuizButton">
						<i class="bi bi-magic"></i> T·∫°o Quiz
					</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="flashcardModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="bi bi-card-checklist"></i> T·∫°o Flashcard
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="flashcardForm">
						<input type="hidden" id="flashcardUserSubjectId">
						<div class="mb-3">
							<label for="flashcardTitle" class="form-label">Ti√™u ƒë·ªÅ b·ªô
								Flashcard:</label> <input type="text" class="form-control"
								id="flashcardTitle" required
								placeholder="V√≠ d·ª•: C√°c thu·∫≠t ng·ªØ Spring Boot">
						</div>
						<div class="mb-3">
							<label for="flashcardTopic" class="form-label">Ch·ªß ƒë·ªÅ
								(T√πy ch·ªçn):</label> <input type="text" class="form-control"
								id="flashcardTopic"
								placeholder="V√≠ d·ª•: Annotations, ho·∫∑c ƒë·ªÉ tr·ªëng">
						</div>
						<div class="mb-3">
							<label for="flashcardNumCards" class="form-label">S·ªë
								l∆∞·ª£ng th·∫ª: <strong id="flashcardCountValue">10</strong> th·∫ª
							</label> <input type="range" class="form-range" id="flashcardNumCards"
								min="10" max="50" step="5" value="10"
								oninput="document.getElementById('flashcardCountValue').innerText = this.value">
						</div>

						<div class="mb-3">
							<label for="flashcardLectureFile" class="form-label"> T·∫£i
								file b√†i gi·∫£ng (tu·ª≥ ch·ªçn) </label> <input class="form-control"
								type="file" id="flashcardLectureFile"
								accept=".pdf,.ppt,.pptx,.doc,.docx,.txt">
							<div class="form-text">N√™n ch·ªçn ƒë√∫ng slide / ch∆∞∆°ng b·∫°n
								mu·ªën t·∫°o Flashcard.</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">ƒê√≥ng</button>
					<button type="button" class="btn btn-warning"
						id="submitFlashcardButton">
						<i class="bi bi-magic"></i> T·∫°o Flashcard
					</button>
				</div>
			</div>
		</div>
	</div>


	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
    // Khai b√°o bi·∫øn global
    let USER_SUBJECT_ID = null;
    let recommendationModal = null;
    let planViewerModal = null;

    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");
        if (!token) { window.location.href = "/login"; return; }

        $.ajaxSetup({
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });
        $("#logoutButton").on("click", logout);

        const pathParts = window.location.pathname.split('/');
        USER_SUBJECT_ID = pathParts[pathParts.length - 1];

        recommendationModal = new bootstrap.Modal(document.getElementById('recommendationModal'));
        planViewerModal = new bootstrap.Modal(document.getElementById('planViewerModal'));

        if (USER_SUBJECT_ID) {
            loadSubjectContent(USER_SUBJECT_ID);
        } else {
            $("#pageLoading").html('<h4 class="text-danger">L·ªói: Kh√¥ng t√¨m th·∫•y ID m√¥n h·ªçc.</h4>');
        }

        $("#quizUserSubjectId").val(USER_SUBJECT_ID);
        $("#flashcardUserSubjectId").val(USER_SUBJECT_ID);
    });


    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    /**
     * H√ÄM XEM L·ªò TR√åNH FULLSCREEN (M·ªöI)
     */
    function showPlanFullscreen(planTitle, planContent) {
    	console.log(planTitle);
        $("#planViewerTitle").text(planTitle);
        $("#planViewerContent").html(marked.parse(planContent || "N·ªôi dung tr·ªëng..."));
        planViewerModal.show();
    }

    /**
     * H√ÄM PH√ÇN TRANG/·∫®N B·ªöT (M·ªöI)
     */
    function toggleView(listSelector, limit, buttonSelector) {
        const items = $(`${listSelector} > a`);
        const isCollapsed = $(buttonSelector).text().includes('·∫®n b·ªõt');

        if (isCollapsed) {
            // Ch·ªâ hi·ªán Top N (·∫®n b·ªõt)
            items.slice(limit).hide();
            $(buttonSelector).text('Xem t·∫•t c·∫£').removeClass('btn-outline-secondary').addClass('btn-primary');
        } else {
            // Hi·ªán t·∫•t c·∫£
            items.show();
            $(buttonSelector).text('·∫®n b·ªõt').removeClass('btn-primary').addClass('btn-outline-secondary');
        }
    }


    function loadSubjectContent(userSubjectId) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/my-subject/${userSubjectId}`,
            success: function(data) {
                // 1. ƒêi·ªÅn th√¥ng tin chung
                $("#subjectTitle").text(data.subjectName + ' - M·∫°ng l∆∞·ªõi Tri th·ª©c');
                $("#subjectName").text(data.subjectName);
                $("#subjectDescription").text(data.subjectDescription);
                $("#subjectProgress").css("width", data.progressPercentage + "%").text(data.progressPercentage + "%");
                $("#currentScore").text(data.currentScore != null ? data.currentScore.toFixed(1) : 'Ch∆∞a c√≥');

                // 2. Load c√°c list (Plans, Quiz, Flashcard)
                renderLists(data);

                // 3. K√≠ch ho·∫°t M·∫°ng l∆∞·ªõi Tri th·ª©c (Ph·∫ßn WOW)
                loadKnowledgeGraph(userSubjectId);

                // 4. Hi·ªÉn th·ªã n·ªôi dung
                $("#pageLoading").hide();
                $("#mainContent").show();
            },
            error: function(xhr) {
                $("#pageLoading").html(`<h4 class="text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu: ${xhr.responseText}</h4>`);
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    function renderLists(data) {
        const LIST_LIMIT = 5;
	
         // 2. Render L·ªô tr√¨nh (Study Plans) - ƒê√É TH√äM N√öT FULLSCREEN
        const studyPlansMap = {};

        const plansAccordion = $("#plansAccordion"); plansAccordion.empty();
        if (data.studyPlans && data.studyPlans.length > 0) {
            data.studyPlans.forEach((plan, index) => {
                const planContent = plan.planContent || "N·ªôi dung tr·ªëng...";
                const planTitle = `L·ªô tr√¨nh #${plan.studyPlanId}`;
                studyPlansMap[plan.studyPlanId] = planContent;

                const escapedContent = planContent.replace(/`/g, '\\`');

                const planItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header d-flex justify-content-between align-items-center">
                             <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${plan.studyPlanId}">
                                ${planTitle} (T·∫°o l√∫c: ${new Date(plan.generatedAt).toLocaleString('vi-VN')})
                            </button>
                                <button class="btn btn-sm btn-outline-primary me-2"
                                    data-plan-id="${plan.studyPlanId}"
                                    data-plan-title="L·ªô tr√¨nh #${plan.studyPlanId}">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </h2>
                        <div id="collapse-${plan.studyPlanId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#plansAccordion">
                            <div class="accordion-body markdown-body">
                                ${marked.parse(planContent)}
                            </div>
                        </div>
                    </div>
                `;
                plansAccordion.append(planItem);
            });
        } else { plansAccordion.html('<p class="text-muted">Ch∆∞a c√≥ l·ªô tr√¨nh n√†o. H√£y quay l·∫°i Dashboard ƒë·ªÉ t·∫°o!</p>'); }
        $("#plansAccordion").on('click', 'button[data-plan-id]', function() {
            const planId = $(this).data('plan-id');
            const planTitle = $(this).data('plan-title');
            const planContent = studyPlansMap[planId];
            showPlanFullscreen(planTitle, planContent);
        });

        // 3. Render Quiz - ƒê√É TH√äM TH·ªêNG K√ä V√Ä PH√ÇN TRANG
        const quizList = $("#quizList"); quizList.empty();
        if (data.quizzes && data.quizzes.length > 0) {
            data.quizzes.forEach((quiz, index) => {
                const isAttempted = quiz.incorrectCount != null;
                const scoreText = isAttempted ?
                    `<span class="text-success fw-bold">${quiz.lastAttemptScore.toFixed(1)}/10</span>` :
                    `<span class="text-secondary">Ch∆∞a l√†m</span>`;
                const errorText = isAttempted && quiz.incorrectCount > 0 ?
                    `<span class="badge bg-danger">${quiz.incorrectCount} sai</span>` : '';

                const quizItem = `
                    <a href="/quiz/${quiz.quizId}" class="list-group-item list-group-item-action">
                        <div>
                            <i class="bi bi-patch-check-fill text-success"></i> ${quiz.title}
                        </div>
                        <div class="d-flex justify-content-between align-items-center small mt-1">
                            <span>ƒêi·ªÉm g·∫ßn nh·∫•t: ${scoreText}</span>
                            <span>${quiz.questionCount} c√¢u ${errorText}</span>
                        </div>
                    </a>
                `;
                quizList.append(quizItem);
            });
            if (data.quizzes.length > LIST_LIMIT) { $("#quizListControls").show(); } else { $("#quizListControls").hide(); }
        } else { quizList.html('<p class="text-muted">Ch∆∞a c√≥ b·ªô Quiz n√†o. H√£y quay l·∫°i Dashboard ƒë·ªÉ t·∫°o!</p>'); $("#quizListControls").hide(); }

        // 4. Render Flashcard
        const flashcardList = $("#flashcardList"); flashcardList.empty();
        if (data.flashcardSets && data.flashcardSets.length > 0) {
            data.flashcardSets.forEach((set, index) => {
                const setItem = `
                    <a href="/flashcards/${set.setId}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-collection-fill text-warning"></i> ${set.title}</span>
                        <span class="badge bg-warning rounded-pill">${set.flashcardCount || '0'} th·∫ª</span>
                    </a>
                `;
                flashcardList.append(setItem);
            });
            if (data.flashcardSets.length > LIST_LIMIT) { $("#flashcardListControls").show(); } else { $("#flashcardListControls").hide(); }
        } else { flashcardList.html('<p class="text-muted">Ch∆∞a c√≥ b·ªô Flashcard n√†o. H√£y quay l·∫°i Dashboard ƒë·ªÉ t·∫°o!</p>'); $("#flashcardListControls").hide(); }
    }


    /**
     * GIAI ƒêO·∫†N 1: V·∫º ƒê·ªí TH·ªä VIS.JS
     */
    function loadKnowledgeGraph(userSubjectId) {
        const container = document.getElementById('knowledge-graph');

        // Loading
        $(container).html(`
            <div class="d-flex flex-column justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu quiz...</p>
            </div>
        `);

        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/knowledge-map/${userSubjectId}`
        })
        .done(function(mapData) { // mapData l√† KnowledgeMapDTO

            const processedNodes = mapData.nodes.map(node => ({
                ...node,
                title: node.title,
                size: 15 + node.quizCount + node.flashcardCount,
                label: node.label
            }));

            const nodes = new vis.DataSet(processedNodes);
            const edges = new vis.DataSet(mapData.edges);

            const data = { nodes: nodes, edges: edges };

            const options = {
                // ƒê√É S·ª¨A: ƒê·ªïi l·∫°i shape th√†nh BOX ƒë·ªÉ ch·ªØ kh√¥ng b·ªã ·∫©n
                nodes: {
                    shape: "box",
                    margin: 10,
                    font: { size: 14, color: "#333", face: "Arial" },
                    borderWidth: 2
                },
                edges: { arrows: "to", color: "#888", smooth: {enabled: true, type: "continuous"} },
                groups: {
                    mastered: { color: { background: "#198754", border: "#155724", highlight: { background: "#28a745", border: "#155724" } }, font: { color: "#fff" } }, // Xanh l√° ƒë·∫≠m
                    learning: { color: { background: "#ffc107", border: "#856404", highlight: { background: "#ffdb58", border: "#856404" } }, font: { color: "#333" } }, // V√†ng
                    struggling: { color: { background: "#dc3545", border: "#721c24", highlight: { background: "#f8d7da", border: "#721c24" } }, font: { color: "#fff" } }, // ƒê·ªè
                    not_started: { color: { background: "#e2e3e5", border: "#6c757d", highlight: { background: "#d0d0d0", border: "#6c757d" } }, font: { color: "#333" } } // X√°m
                },
                // FIX HITBOX: S·ª≠ d·ª•ng solver v·∫≠t l√Ω t·ªët h∆°n ƒë·ªÉ k√©o th·∫£ d·ªÖ h∆°n
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -100,
                        springConstant: 0.04,
                        avoidOverlap: 0.5 // Gi·∫£m ƒë·ªô tr√°nh ch·ªìng ch√©o
                    },
                    maxVelocity: 15,
                    minVelocity: 0.75,
                    timestep: 0.5,
                    stabilization: { iterations: 250 }
                },
                layout: { hierarchical: { enabled: false } },
                interaction: { hover: true, tooltipDelay: 100, zoomSpeed: 0.5 }
            };

            const network = new vis.Network(container, data, options);

            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const topicId = params.nodes[0];
                    const node = nodes.get(topicId);
                    showRecommendationForTopic(USER_SUBJECT_ID, node);
                }
            });

        })
        .fail(function(xhr) {
            $(container).html(`
                <div class="d-flex flex-column justify-content-center align-items-center h-100">
                    <i class="bi bi-exclamation-triangle-fill text-danger fs-1"></i>
                    <p class="mt-3 text-danger">Kh√¥ng th·ªÉ t·∫£i M·∫°ng l∆∞·ªõi Tri th·ª©c. Vui l√≤ng ki·ªÉm tra l·ªói server (L·ªói: ${xhr.statusText || xhr.status}).</p>
                </div>
            `);
        });
    }


    /**
     * H√ÄM PH√ÇN TRANG/·∫®N B·ªöT (M·ªöI)
     */
    function toggleView(listSelector, limit, buttonSelector) {
        const items = $(`${listSelector} > a`);
        const isCollapsed = $(buttonSelector).text().includes('·∫®n b·ªõt');

        if (isCollapsed) {
            items.slice(limit).hide();
            $(buttonSelector).text('Xem t·∫•t c·∫£').removeClass('btn-outline-secondary').addClass('btn-primary');
        } else {
            items.show();
            $(buttonSelector).text('·∫®n b·ªõt').removeClass('btn-primary').addClass('btn-outline-secondary');
        }
    }


    /**
     * GIAI ƒêO·∫†N 2: T∆Ø∆†NG T√ÅC V√Ä ƒê·ªÄ XU·∫§T TH√îNG MINH
     */
    function showRecommendationForTopic(userSubjectId, node) {
        const modalTitle = $("#recommendationTitle");
        const modalBody = $("#recommendationBody");

        modalTitle.text(`Ch·ªß ƒë·ªÅ: ${node.label}`);

        modalBody.html('<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"></div></div> <p class="text-center mt-2">AI ƒëang ph√¢n t√≠ch...</p>');
        recommendationModal.show();

        // TR∆Ø·ªúNG H·ª¢P 1: GI·ªéI HO·∫∂C CH∆ØA B·∫ÆT ƒê·∫¶U (Kh√¥ng c·∫ßn g·ªçi AI)
        if (node.group === 'mastered') {
            modalBody.html('<div class="congrats-message">üéâ Ch·ªß ƒë·ªÅ n√†y b·∫°n ƒë√£ th√¥ng th·∫°o! Ti·∫øp t·ª•c ph√°t huy nh√©.</div>');
            return;
        }

        if (node.group === 'not_started') {
            modalBody.html('<div class="ai-message text-center">üí° Ch·ªß ƒë·ªÅ n√†y ch∆∞a c√≥ d·ªØ li·ªáu l√†m b√†i. B·∫°n c√≥ th·ªÉ t·∫°o m·ªôt b√†i Quiz v·ªÅ **' + node.label + '** ho·∫∑c xem t√†i li·ªáu li√™n quan!</div>');
            return;
        }

        // K·ªäCH B·∫¢N 2: Y·∫æU (ƒê·ªé/V√ÄNG) -> G·ªåI API ADAPTIVE
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/adaptive/recommendation/${userSubjectId}`
        })
        .done(function(data) {
             buildRecommendationUI(modalBody, data);
        })
        .fail(function(xhr) {
             modalBody.html(`<div class="ai-error-message">L·ªói khi l·∫•y ƒë·ªÅ xu·∫•t AI: ${xhr.statusText}</div>`);
        });

    }

    /**
     * H√ÄM "V·∫º" TH·∫∫ ƒê·ªÄ XU·∫§T (Sao ch√©p t·ª´ dashboard)
     */
    function buildRecommendationUI(containerElement, data) {
        let html = '';

        if (data.recommendationProvided) {
            const content = data.recommendedContent;
            let videoThumbnail = '';
            if (content.contentType === 'VIDEO' && content.urlOrData && content.urlOrData.includes('youtube.com')) {
                try {
                    const url = new URL(content.urlOrData);
                    const videoId = url.searchParams.get('v');
                    if(videoId) { videoThumbnail = `<img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" class="img-fluid rounded mb-2" alt="Video thumbnail">`; }
                } catch(e) {}
            }
            html = `
                <div class="header">üåü G·ª£i √Ω t·ª´ Tr·ª£ l√Ω AI</div>
                <div class="ai-message">
                    "${data.recommendationText}"
                </div>
                <a href="${content.urlOrData}" target="_blank" class="content-card">
                    ${videoThumbnail}
                    <div class="content-type">${content.contentType}</div>
                    <div class="content-title">${content.title}</div>
                    <div class="content-duration">‚è±Ô∏è ∆Ø·ªõc t√≠nh: ${content.estimatedDurationMinutes} ph√∫t</div>
                </a>
            `;
        }
        else {
            html = `
                <div class="header">üéâ Th√¥ng b√°o t·ª´ AI</div>
                <div class="congrats-message">
                    ${data.recommendationText}
                </div>
            `;
        }
        containerElement.html(html);
    }
    $("#submitFlashcardButton").on("click", function(e) {
    e.preventDefault();
    const $btn = $(this);
    const $form = $("#flashcardForm");

    // 0. L·∫•y ti√™u ƒë·ªÅ (b·∫Øt bu·ªôc)
    const title = $("#flashcardTitle").val();
    if (!title) {
        alert("Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ cho b·ªô flashcard.");
        return;
    }

    // 1. L·∫•y file
    const fileInput = document.getElementById('flashcardLectureFile');
    const file = (fileInput && fileInput.files.length > 0) ? fileInput.files[0] : null;

    // 2. Chu·∫©n b·ªã d·ªØ li·ªáu JSON
    const requestData = {
        userSubjectId: parseInt(USER_SUBJECT_ID, 10),
        title: title,
        topic: $("#flashcardTopic").val() || null,
        numberOfCards: parseInt($("#flashcardNumCards").val(), 10)
    };
   
    // 3. T·∫°o FormData (v√¨ c√≥ file ƒë√≠nh k√®m)
    const formData = new FormData();
    formData.append("request", new Blob([JSON.stringify(requestData)], {
        type: "application/json"
    }));

    if (file) {
        formData.append("lectureFile", file);
    }


    // 4. G·ª≠i AJAX
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫°o...');

    $.ajax({
        type: "POST",
        url: "http://localhost:8080/api/flashcards/generate", // API n√†y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        data: formData,
        processData: false, // B·∫Øt bu·ªôc
        contentType: false, // B·∫Øt bu·ªôc
        // (Kh√¥ng c·∫ßn header Authorization v√¨ $.ajaxSetup ƒë√£ lo)
        success: function(newSet) {
            alert(`T·∫°o th√†nh c√¥ng b·ªô flashcard: ${newSet.title}`);
            // ƒê√≥ng modal v√† t·∫£i l·∫°i trang
            bootstrap.Modal.getInstance($("#flashcardModal")).hide();
            location.reload();
        },
        error: function(xhr) {
            alert("L·ªói khi t·∫°o flashcard: " + (xhr.responseJSON?.message || xhr.responseText));
            $btn.prop('disabled', false).html('<i class="bi bi-magic"></i> T·∫°o Flashcard');
        }
    });
});
</script>
</body>
</html>