<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Learning</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        .loading-spinner {
            display: none; /* Ẩn mặc định */
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: text-bottom;
            border: .2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: .75s linear infinite spinner-border;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard"><i class="bi bi-brain"></i> Smart Learning</a>
        <div class="d-flex">
            <span class="navbar-text me-3" id="welcomeMessage"></span>
            <button class="btn btn-outline-light" id="logoutButton"><i class="bi bi-box-arrow-right"></i> Đăng xuất</button>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <div class="row mb-4">
        <div class="col-md-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title">Thời gian học (phút)</h5>
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h5 class="card-title">Thống kê hoạt động</h5>
                    <canvas id="activityChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <hr>
    <h3 class="mb-3">Khám phá các môn học</h3>
    <div class="row" id="subjectsList">
        <div class="col-12 text-center" id="subjectsLoading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Đang tải danh sách môn học...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo Lộ trình học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planUserSubjectId">
                    <div class="mb-3">
                        <label for="customPrompt" class="form-label">Yêu cầu tùy chỉnh:</label>
                        <textarea class="form-control" id="customPrompt" rows="3" placeholder="Ví dụ: Tập trung vào thực hành, hoặc tạo lộ trình trong 3 tuần..."></textarea>
                    </div>
                    <div id="planResult" class="mt-3 p-3 bg-light border rounded" style="display: none; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="submitPlanButton">
                    <span class="loading-spinner" role="status"></span>
                    Tạo
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let currentUserId = null;
    let timeChartInstance = null;
    let activityChartInstance = null;
    let planModal = null; // Biến cho Modal

    /**
     * Hàm chạy đầu tiên
     */
    $(document).ready(function() {
        // 1. Kiểm tra đăng nhập
        const token = localStorage.getItem("jwtToken");
        const username = localStorage.getItem("username");

        if (!token) {
            window.location.href = "/login";
            return;
        }

        // 2. Gắn Token vào tất cả request
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        // 3. Setup UI
        $("#welcomeMessage").text("Chào, " + username);
        $("#logoutButton").on("click", logout);
        planModal = new bootstrap.Modal(document.getElementById('planModal'));

        // 4. Bắt đầu tải dữ liệu
        loadUserData(username);

        // 5. Gắn sự kiện cho nút "Tạo" trong Modal
        $("#submitPlanButton").on("click", handleGeneratePlan);
    });

    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }

    /**
     * Bước 1: Lấy UserId
     */
    function loadUserData(username) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/users/${username}`,
            success: function(userDTO) {
                currentUserId = userDTO.userId;
                loadDashboardData(currentUserId);
                loadSubjectsAndEnrollments(currentUserId); // Nâng cấp hàm này
            },
            error: function(xhr) {
                if (xhr.status === 401 || xhr.status === 403) logout();
            }
        });
    }

    /**
     * Bước 2: Tải dữ liệu Chart.js
     */
    function loadDashboardData(userId) {
        $.ajax({
            type: "GET",
            url: `http://localhost:8080/api/dashboard/${userId}`,
            success: function(data) {
                renderTimeChart(data.timeLabels || [], data.timeData || []);
                renderActivityChart(data.activityCounts || {});
            },
            error: function(xhr) { console.error("Lỗi tải dashboard:", xhr.responseText); }
        });
    }

    /**
     * Bước 3 (ĐÃ NÂNG CẤP): Tải tất cả môn học VÀ các môn đã đăng ký
     */
    async function loadSubjectsAndEnrollments(userId) {
        try {
            // 1. Lấy danh sách MÔN ĐÃ ĐĂNG KÝ (UserSubjectDTO)
            const enrolledSubjects = await $.ajax({
                type: "GET",
                url: `http://localhost:8080/api/users/${userId}/subjects`
            });

            // Tạo một Map để tra cứu nhanh (subjectId -> userSubjectId)
            const enrolledMap = new Map();
            enrolledSubjects.forEach(us => {
                enrolledMap.set(us.subject.subjectId, us.id); // Map: (subjectId -> userSubjectId)
            });

            // 2. Lấy TẤT CẢ môn học (SubjectDTO)
            const allSubjects = await $.ajax({
                type: "GET",
                url: "http://localhost:8080/api/subjects"
            });

            // 3. Render
            const subjectsListDiv = $("#subjectsList");
            subjectsListDiv.empty(); // Xóa spinner

            allSubjects.forEach(subject => {
                const userSubjectId = enrolledMap.get(subject.subjectId);
                let buttonHtml = '';

                if (userSubjectId) {
                    // ĐÃ ĐĂNG KÝ
                    buttonHtml = `
                        <button class="btn btn-primary btn-sm me-1" onclick="openPlanModal(${userSubjectId})">
                            <i class="bi bi-calendar-check"></i> Tạo Lộ trình
                        </button>
                        <button class="btn btn-success btn-sm" onclick="openQuizModal(${userSubjectId})">
                            <i class="bi bi-patch-question"></i> Tạo Quiz
                        </button>
                    `;
                } else {
                    // CHƯA ĐĂNG KÝ
                    buttonHtml = `
                        <button class="btn btn-outline-primary" id="enrollBtn-${subject.subjectId}" onclick="enroll(${subject.subjectId})">
                            <span class="loading-spinner" id="enrollSpinner-${subject.subjectId}"></span>
                            Đăng ký học
                        </button>
                    `;
                }

                const subjectCard = `
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${subject.subjectName}</h5>
                                <p class="card-text text-muted">${subject.description.substring(0, 100)}...</p>
                                <div class="mt-auto">${buttonHtml}</div>
                            </div>
                        </div>
                    </div>
                `;
                subjectsListDiv.append(subjectCard);
            });

        } catch (xhr) {
            console.error("Lỗi khi tải môn học:", xhr.responseText);
            $("#subjectsList").html('<div class="alert alert-danger">Không thể tải danh sách môn học.</div>');
        }
    }

    /**
     * Bước 4: Xử lý Đăng ký môn học
     */
    function enroll(subjectId) {
        const btn = $(`#enrollBtn-${subjectId}`);
        const spinner = $(`#enrollSpinner-${subjectId}`);

        btn.prop('disabled', true); // Khóa nút
        spinner.show();

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/enroll",
            contentType: "application/json",
            data: JSON.stringify({ userId: currentUserId, subjectId: subjectId }),
            success: function(userSubjectDTO) {
                // Tải lại danh sách môn học để cập nhật nút
                loadSubjectsAndEnrollments(currentUserId);
            },
            error: function(xhr) {
                alert("Lỗi khi đăng ký: " + xhr.responseText);
                btn.prop('disabled', false); // Mở lại nút
                spinner.hide();
            }
        });
    }

    /**
     * Bước 5: Mở Modal và Gán ID
     */
    function openPlanModal(userSubjectId) {
        // 1. Gán userSubjectId vào input ẩn của form
        $("#planUserSubjectId").val(userSubjectId);
        // 2. Reset form
        $("#planForm")[0].reset();
        $("#planResult").hide().empty();
        $("#submitPlanButton").prop('disabled', false);
        $("#submitPlanButton .loading-spinner").hide();
        // 3. Mở Modal
        planModal.show();
    }

    function openQuizModal(userSubjectId) {
        alert("Sắp ra mắt: Tạo Quiz cho userSubjectId " + userSubjectId);
        // (Tương tự: tạo quizModal, gán ID, và mở)
    }

    /**
     * Bước 6: Gọi API Tạo Lộ trình (từ Modal)
     */
    function handleGeneratePlan() {
        const btn = $("#submitPlanButton");
        const spinner = btn.find(".loading-spinner");

        btn.prop('disabled', true);
        spinner.show();
        $("#planResult").hide().empty();

        const requestData = {
            userSubjectId: $("#planUserSubjectId").val(),
            customPrompt: $("#customPrompt").val()
        };

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/study-plans/generate",
            contentType: "application/json",
            data: JSON.stringify(requestData),
            success: function(planDTO) {
                // Hiển thị kết quả (Markdown/Text)
                $("#planResult").text(planDTO.planContent).show();
            },
            error: function(xhr) {
                $("#planResult").text("Lỗi: " + xhr.responseText).show();
            },
            complete: function() {
                // Chạy khi success hoặc error
                btn.prop('disabled', false);
                spinner.hide();
            }
        });
    }

    // --- (Các hàm vẽ biểu đồ giữ nguyên) ---
    function renderTimeChart(labels, data) {
        if(timeChartInstance) timeChartInstance.destroy();
        const ctx = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Số phút đã học', data: data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });
    }
    function renderActivityChart(activityData) {
        if(activityChartInstance) activityChartInstance.destroy();
        const ctx = document.getElementById('activityChart').getContext('2d');
        activityChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(activityData), datasets: [{ data: Object.values(activityData), backgroundColor: ['rgba(0, 123, 255, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

</script>
</body>
</html>